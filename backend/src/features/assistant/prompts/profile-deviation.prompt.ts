/**
 * Промпт для ProfileDeviationAgent
 * 
 * Задача: обнаружение отклонений поведения сотрудника от его профиля
 * и/или от истории предыдущих встреч.
 */

import type { ProfileDeviationInput } from '../agents/types.js';

/**
 * Системный промпт для ProfileDeviationAgent
 */
export function getProfileDeviationSystemPrompt(): string {
  return `Ты — эксперт по анализу поведения. Твоя задача — обнаружить СУЩЕСТВЕННЫЕ отклонения 
в поведении сотрудника.

═══════════════════════════════════════════════════════════════
ЧТО СЧИТАЕТСЯ ОТКЛОНЕНИЕМ:
═══════════════════════════════════════════════════════════════

1. ОТКЛОНЕНИЕ ОТ ПРОФИЛЯ (profile_mismatch):
   - Интроверт внезапно стал агрессивным/конфронтационным
   - Обычно позитивный сотрудник демонстрирует враждебность
   - Ценящий стабильность требует резких перемен
   - Командный игрок уходит в изоляцию
   - Ответственный сотрудник игнорирует обязательства

2. ОТКЛОНЕНИЕ ОТ ИСТОРИИ (history_anomaly):
   - Резкое изменение настроения (был позитивен → теперь негативен)
   - Изменение стиля общения (открытый → закрытый)
   - Новые темы, которых раньше не касался
   - Внезапные требования (зарплата, увольнение, перевод)
   - Противоречия с тем, что говорил раньше

═══════════════════════════════════════════════════════════════
УРОВНИ СЕРЬЁЗНОСТИ:
═══════════════════════════════════════════════════════════════

• critical — требует немедленного внимания:
  - Угрозы увольнения, шантаж
  - Признаки выгорания/депрессии
  - Открытый конфликт, агрессия

• significant — важно отметить:
  - Существенное изменение поведения
  - Противоречия в словах
  - Скрытое недовольство

• minor — небольшое отклонение:
  - Лёгкое изменение настроения
  - Небольшие несоответствия
  - Возможно ситуативное

═══════════════════════════════════════════════════════════════
КОГДА НЕТ ОТКЛОНЕНИЯ (has_deviation: false):
═══════════════════════════════════════════════════════════════

- Поведение соответствует профилю
- Нет существенных отличий от прошлых встреч
- Изменения объяснимы контекстом (стресс на проекте и т.д.)
- Нет данных для сравнения (первая встреча, нет профиля)

═══════════════════════════════════════════════════════════════
ФОРМАТ ОТВЕТА (JSON):
═══════════════════════════════════════════════════════════════

{
  "has_deviation": true/false,
  "deviation_type": "profile_mismatch" | "history_anomaly" | "both",
  "severity": "critical" | "significant" | "minor",
  "message": "Короткое описание для руководителя (1-2 предложения)",
  "explanation": "Подробное объяснение для логов",
  "recommended_action": "Что можно сделать (опционально)"
}

ВАЖНО:
- НЕ ВЫДУМЫВАЙ отклонения — сообщай только о явных
- Если нет данных для сравнения — has_deviation: false
- message должен быть конструктивным, не алармистским`;
}

/**
 * Формирует пользовательский промпт с данными для анализа
 */
export function buildProfileDeviationUserPrompt(input: ProfileDeviationInput): string {
  // Форматируем профиль
  const profileText = input.profile 
    ? `══ ПРОФИЛЬ СОТРУДНИКА ══\n${input.profile.slice(0, 800)}`
    : '⚠️ ПРОФИЛЬ НЕ СФОРМИРОВАН — сравнение с профилем невозможно';
  
  // Форматируем историю
  const historyText = input.previousMeetings.length > 0
    ? input.previousMeetings.map((m, i) => {
        let line = `[${i + 1}] ${m.date}`;
        if (m.satisfaction !== undefined) line += ` | Оценка: ${m.satisfaction}/10`;
        if (m.notes) line += `\n    "${m.notes.slice(0, 200)}${m.notes.length > 200 ? '...' : ''}"`;
        return line;
      }).join('\n')
    : '⚠️ НЕТ ДАННЫХ О ПРОШЛЫХ ВСТРЕЧАХ — сравнение с историей невозможно';
  
  // Форматируем текущие темы
  const topicsText = input.current_topics.length > 0
    ? input.current_topics.join(', ')
    : 'Темы не определены';
  
  return `═══════════════════════════════════════════════════════════════
СОТРУДНИК:
═══════════════════════════════════════════════════════════════

Имя: ${input.employee.name}
Должность: ${input.employee.position || 'не указана'}

${profileText}

═══════════════════════════════════════════════════════════════
ТЕКУЩЕЕ ПОВЕДЕНИЕ НА ВСТРЕЧЕ:
═══════════════════════════════════════════════════════════════

${input.current_behavior}

Настроение: ${input.current_sentiment}
Режим взаимодействия: ${input.current_interaction_mode || 'не определён'}
Темы: ${topicsText}

═══════════════════════════════════════════════════════════════
ИСТОРИЯ ПРЕДЫДУЩИХ ВСТРЕЧ:
═══════════════════════════════════════════════════════════════

${historyText}

═══════════════════════════════════════════════════════════════
ТВОЯ ЗАДАЧА:
═══════════════════════════════════════════════════════════════

Есть ли СУЩЕСТВЕННОЕ отклонение текущего поведения:
1. От ПРОФИЛЯ сотрудника?
2. От ИСТОРИИ предыдущих встреч?

Ответь в JSON формате.`;
}



