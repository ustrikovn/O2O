<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сотрудники - O2O</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link rel="stylesheet" href="shared/styles/base.css">
</head>
<body>
    <div class="flex min-h-screen">
        <!-- Sidebar Container -->
        <div id="sidebar-container"></div>
        
        <!-- Main Content -->
        <div class="flex-1 ml-64 p-8">
            <!-- Add Employee Button -->
            <div class="mb-6">
                <div id="add-employee-button-container"></div>
            </div>

            <!-- Employees List Container -->
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="employees-list">
                <!-- Здесь будут отображаться карточки сотрудников -->
                <div class="glass-card p-6 text-center col-span-full">
                    <div class="text-gray-500">
                        <i data-feather="loader" class="mx-auto mb-4 animate-spin"></i>
                        <p>Загрузка сотрудников...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="shared/ui/sidebar.js"></script>
    <script src="shared/ui/modal.js"></script>
    <script src="shared/ui/add-employee-form.js"></script>
    <script src="shared/ui/add-employee-button.js"></script>
    <script>
        // Инициализация компонентов
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = new O2OSidebar('employees');
            sidebar.mount('sidebar-container');
            
            // Инициализация кнопки добавления сотрудника
            const addEmployeeButton = new AddEmployeeButton({
                text: 'Добавить сотрудника',
                icon: 'user-plus',
                onClick: function() {
                    console.log('Открыть форму добавления сотрудника');
                    
                    // Создаем и показываем форму
                    const addEmployeeForm = new AddEmployeeForm({
                        title: 'Добавление сотрудника',
                        onSubmit: async function(employeeData) {
                            console.log('Отправка данных сотрудника:', employeeData);
                            
                            try {
                                // Создаем FormData для отправки включая файл
                                const formData = new FormData();
                                formData.append('firstName', employeeData.firstName);
                                formData.append('lastName', employeeData.lastName);
                                formData.append('email', employeeData.email);
                                formData.append('position', employeeData.position);
                                formData.append('team', employeeData.team);
                                
                                if (employeeData.photo) {
                                    formData.append('photo', employeeData.photo);
                                }
                                
                                // Отправляем данные на сервер
                                const response = await fetch('http://localhost:3001/api/employees', {
                                    method: 'POST',
                                    body: formData
                                });
                                
                                const result = await response.json();
                                
                                if (response.ok && result.success) {
                                    alert(`Сотрудник ${employeeData.firstName} ${employeeData.lastName} успешно добавлен!`);
                                    console.log('Сотрудник создан:', result.data);
                                    
                                    // Перезагружаем страницу для обновления списка
                                    window.location.reload();
                                } else {
                                    console.error('Ошибка создания сотрудника:', result);
                                    alert('Ошибка: ' + (result.message || result.error || 'Не удалось создать сотрудника'));
                                }
                            } catch (error) {
                                console.error('Ошибка отправки данных:', error);
                                alert('Ошибка соединения с сервером. Проверьте, что backend запущен.');
                            }
                        },
                        onCancel: function() {
                            console.log('Добавление сотрудника отменено');
                        }
                    });
                    
                    addEmployeeForm.show();
                }
            });
            addEmployeeButton.mount('add-employee-button-container');
            
            // Загрузка списка сотрудников
            loadEmployees();
            
            // Инициализация иконок
            feather.replace();
        });
        
        // Функция загрузки сотрудников
        async function loadEmployees() {
            try {
                const response = await fetch('http://localhost:3001/api/employees');
                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayEmployees(result.data);
                } else {
                    console.error('Ошибка загрузки сотрудников:', result);
                }
            } catch (error) {
                console.error('Ошибка подключения к серверу:', error);
                // Показываем сообщение только если backend недоступен
                const employeesList = document.getElementById('employees-list');
                employeesList.innerHTML = `
                    <div class="glass-card p-6 text-center col-span-full">
                        <div class="text-red-500">
                            <i data-feather="alert-circle" class="mx-auto mb-4"></i>
                            <p class="font-medium">Не удается подключиться к серверу</p>
                            <p class="text-sm mt-2">Убедитесь, что backend сервер запущен на порту 3001</p>
                        </div>
                    </div>
                `;
                feather.replace();
            }
        }
        
        // Функция отображения сотрудников
        function displayEmployees(employees) {
            const employeesList = document.getElementById('employees-list');
            
            if (employees.length === 0) {
                employeesList.innerHTML = `
                    <div class="glass-card p-6 text-center col-span-full">
                        <div class="text-gray-500">
                            <i data-feather="users" class="mx-auto mb-4"></i>
                            <p>Пока нет добавленных сотрудников</p>
                            <p class="text-sm mt-2">Нажмите кнопку выше, чтобы добавить первого сотрудника</p>
                        </div>
                    </div>
                `;
            } else {
                employeesList.innerHTML = employees.map(employee => `
                    <div class="glass-card p-6">
                        <div class="flex items-center space-x-4">
                            <div class="flex-shrink-0">
                                ${employee.photoUrl ? 
                                    `<img src="${employee.photoUrl}" alt="${employee.first_name} ${employee.last_name}" class="w-12 h-12 rounded-full object-cover">` :
                                    `<div class="w-12 h-12 rounded-full bg-primary-blue text-white flex items-center justify-center font-medium">
                                        ${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}
                                    </div>`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-medium text-gray-900 truncate">
                                    ${employee.first_name} ${employee.last_name}
                                </h3>
                                <p class="text-sm text-gray-600">${employee.position}</p>
                                <p class="text-sm text-gray-500">${employee.team}</p>
                                <p class="text-xs text-gray-400 mt-1">${employee.email}</p>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button class="glass-button px-3 py-1 text-sm text-primary-blue hover:bg-primary-blue hover:text-white transition-colors">
                                Подробнее
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            feather.replace();
        }
    </script>
</body>
</html>