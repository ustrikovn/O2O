<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сотрудники - O2O</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link rel="stylesheet" href="shared/styles/base.css">
    <style>
        /* Стили карточек профилей из UI-kit */
        .profile-card {
            transition: all 300ms ease;
        }
        
        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        
        /* Стили кнопок из UI-kit */
        .glass-button {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 300ms ease-in-out;
        }
        
        .glass-button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="flex min-h-screen">
        <!-- Sidebar Container -->
        <div id="sidebar-container"></div>
        
        <!-- Main Content -->
        <div class="flex-1 ml-64 p-8">
            <!-- Add Employee Button -->
            <div class="mb-6">
                <div id="add-employee-button-container"></div>
            </div>

            <!-- Employees List Container -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="employees-list">
                <!-- Здесь будут отображаться карточки сотрудников -->
                <div class="glass-card p-6 text-center col-span-full">
                    <div class="text-gray-500">
                        <i data-feather="loader" class="mx-auto mb-4 animate-spin"></i>
                        <p>Загрузка сотрудников...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="shared/ui/sidebar.js"></script>
    <script src="shared/ui/modal.js"></script>
    <script src="shared/ui/add-employee-form.js"></script>
    <script src="shared/ui/add-employee-button.js"></script>
    <script>
        // Инициализация компонентов
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = new O2OSidebar('employees');
            sidebar.mount('sidebar-container');
            
            // Инициализация кнопки добавления сотрудника
            const addEmployeeButton = new AddEmployeeButton({
                text: 'Добавить сотрудника',
                icon: 'user-plus',
                onClick: function() {
                    console.log('Открыть форму добавления сотрудника');
                    
                    // Создаем и показываем форму
                    const addEmployeeForm = new AddEmployeeForm({
                        title: 'Добавление сотрудника',
                        onSubmit: async function(employeeData) {
                            console.log('Отправка данных сотрудника:', employeeData);
                            
                            try {
                                // Создаем FormData для отправки включая файл
                                const formData = new FormData();
                                formData.append('firstName', employeeData.firstName);
                                formData.append('lastName', employeeData.lastName);
                                formData.append('email', employeeData.email);
                                formData.append('position', employeeData.position);
                                formData.append('team', employeeData.team);
                                
                                if (employeeData.photo) {
                                    formData.append('photo', employeeData.photo);
                                }
                                
                                // Отправляем данные на сервер
                                const response = await fetch('http://localhost:3001/api/employees', {
                                    method: 'POST',
                                    body: formData
                                });
                                
                                const result = await response.json();
                                
                                if (response.ok && result.success) {
                                    alert(`Сотрудник ${employeeData.firstName} ${employeeData.lastName} успешно добавлен!`);
                                    console.log('Сотрудник создан:', result.data);
                                    
                                    // Перезагружаем страницу для обновления списка
                                    window.location.reload();
                                } else {
                                    console.error('Ошибка создания сотрудника:', result);
                                    alert('Ошибка: ' + (result.message || result.error || 'Не удалось создать сотрудника'));
                                }
                            } catch (error) {
                                console.error('Ошибка отправки данных:', error);
                                alert('Ошибка соединения с сервером. Проверьте, что backend запущен.');
                            }
                        },
                        onCancel: function() {
                            console.log('Добавление сотрудника отменено');
                        }
                    });
                    
                    addEmployeeForm.show();
                }
            });
            addEmployeeButton.mount('add-employee-button-container');
            
            // Загрузка списка сотрудников
            loadEmployees();
            
            // Инициализация иконок
            feather.replace();
        });
        
        // Функция загрузки сотрудников
        async function loadEmployees() {
            try {
                const response = await fetch('http://localhost:3001/api/employees');
                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayEmployees(result.data);
                } else {
                    console.error('Ошибка загрузки сотрудников:', result);
                }
            } catch (error) {
                console.error('Ошибка подключения к серверу:', error);
                // Показываем сообщение только если backend недоступен
                const employeesList = document.getElementById('employees-list');
                employeesList.innerHTML = `
                    <div class="glass-card p-6 text-center col-span-full">
                        <div class="text-red-500">
                            <i data-feather="alert-circle" class="mx-auto mb-4"></i>
                            <p class="font-medium">Не удается подключиться к серверу</p>
                            <p class="text-sm mt-2">Убедитесь, что backend сервер запущен на порту 3001</p>
                        </div>
                    </div>
                `;
                feather.replace();
            }
        }
        
        // Функция отображения сотрудников
        function displayEmployees(employees) {
            const employeesList = document.getElementById('employees-list');
            
            if (employees.length === 0) {
                employeesList.innerHTML = `
                    <div class="glass-card p-6 text-center col-span-full">
                        <div class="text-gray-500">
                            <i data-feather="users" class="mx-auto mb-4"></i>
                            <p>Пока нет добавленных сотрудников</p>
                            <p class="text-sm mt-2">Нажмите кнопку выше, чтобы добавить первого сотрудника</p>
                        </div>
                    </div>
                `;
            } else {
                employeesList.innerHTML = employees.map(employee => `
                    <div class="profile-card glass-card p-6">
                        <div class="flex items-center mb-5">
                            <div class="relative">
                                ${employee.photoUrl ? 
                                    `<img src="${employee.photoUrl}" alt="${employee.first_name} ${employee.last_name}" class="w-16 h-16 rounded-full object-cover">` :
                                    `<div class="w-16 h-16 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg">
                                        ${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}
                                    </div>`
                                }
                                <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-400 rounded-full border-2 border-white"></div>
                            </div>
                            <div class="ml-4">
                                <h2 class="font-bold text-lg">${employee.first_name} ${employee.last_name}</h2>
                                <p class="text-gray-600 text-sm">${employee.position}</p>
                            </div>
                        </div>
                        
                        <div class="mb-5">
                            <div class="flex justify-between text-sm mb-1">
                                <span>Engagement Score</span>
                                <span>92%</span>
                            </div>
                            <div class="w-full h-1.5 bg-gray-200 rounded-full">
                                <div class="h-1.5 bg-green-500 rounded-full" style="width: 92%"></div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between pt-4 border-t border-white/10">
                            <button class="glass-button px-4 py-2 text-sm flex items-center">
                                <i data-feather="eye" class="mr-1"></i> View Profile
                            </button>
                            <button class="glass-button px-4 py-2 text-sm flex items-center">
                                <i data-feather="calendar" class="mr-1"></i> Schedule
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            feather.replace();
        }
    </script>
</body>
</html>