<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проведение One-to-One - O2O</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link rel="stylesheet" href="shared/styles/base.css">
    <style>
        /* Дополнительные стили для страницы встречи */
        .text-error { color: var(--error); }
        .text-warning { color: var(--warning); }
        .text-success { color: var(--success); }
        .text-info { color: var(--info); }
        .text-primary { color: var(--primary-blue); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }
        
        /* Дополнительные стили для метрик */
        .text-xs br { line-height: 1.1; }
        
        /* Donut Chart анимации */
        svg path {
            transition: stroke-dasharray 0.6s ease-in-out;
        }
        
        /* Hover эффекты для метрик */
        .metric-container:hover svg path:last-child {
            stroke-width: 3;
        }

        /* Custom checkbox styling */
        .custom-checkbox {
            appearance: none;
            width: 1rem;
            height: 1rem;
            border: 1px solid var(--primary-blue);
            border-radius: 0.25rem;
            background: var(--glass-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .custom-checkbox:checked {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .custom-checkbox:hover {
            border-color: var(--primary-blue);
        }
        
        .bg-error { background-color: var(--error); }
        .bg-warning { background-color: var(--warning); }
        .bg-success { background-color: var(--success); }
        .bg-info { background-color: var(--info); }
        .bg-primary { background-color: var(--primary-blue); }
        
        /* Стили для тегов сотрудника */
        .employee-tag {
            display: inline-block;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .employee-tag:hover {
            transform: translateY(-1px);
        }
        
        /* Простая цветовая схема - только синий и серый */
        .team-tag {
            background: rgba(74, 144, 226, 0.15);
            border: 1px solid rgba(74, 144, 226, 0.3);
            color: var(--primary-blue);
        }
        
        .team-tag:hover {
            background: rgba(74, 144, 226, 0.25);
        }
        
        .experience-tag {
            background: rgba(107, 114, 128, 0.15);
            border: 1px solid rgba(107, 114, 128, 0.3);
            color: #6b7280;
        }
        
        .experience-tag:hover {
            background: rgba(107, 114, 128, 0.25);
        }
        
        .skill-tag {
            background: rgba(74, 144, 226, 0.15);
            border: 1px solid rgba(74, 144, 226, 0.3);
            color: var(--primary-blue);
        }
        
        .skill-tag:hover {
            background: rgba(74, 144, 226, 0.25);
        }
        
        .motivator-tag {
            background: rgba(107, 114, 128, 0.15);
            border: 1px solid rgba(107, 114, 128, 0.3);
            color: #6b7280;
        }
        
        .motivator-tag:hover {
            background: rgba(107, 114, 128, 0.25);
        }
        
        .activity-tag {
            background: rgba(74, 144, 226, 0.15);
            border: 1px solid rgba(74, 144, 226, 0.3);
            color: var(--primary-blue);
        }
        
        .activity-tag:hover {
            background: rgba(74, 144, 226, 0.25);
        }
        
        /* Фиксированная ширина для кнопки встречи */
        #start-meeting-btn {
            width: 170px;
            white-space: nowrap;
            height: 38px;
        }
        
        /* Фиксированная высота для кнопки смены сотрудника */
        button[onclick="changeEmployee()"] {
            height: 38px;
        }
        
        /* Стилизация range slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Адаптивность для мобильных устройств */
        @media (max-width: 1024px) {
            .lg\\:col-span-2 {
                grid-column: span 1;
            }
            
            .lg\\:grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .lg\\:grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .flex-1.ml-64 {
                margin-left: 0;
                padding: 1rem;
            }
            
            #metrics-block .flex.items-start.space-x-8 {
                flex-wrap: wrap;
                gap: 1rem;
                justify-content: center;
            }
        }
        
        @media (max-width: 768px) {
            .grid.grid-cols-1.lg\\:grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            #employee-info-block .flex.items-start.space-x-4 {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
                text-align: center;
            }
            
            /* Адаптивность для блока тегов */
            .glass-card .flex.items-center.justify-between {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .glass-card .flex.items-center.justify-between > div:first-child {
                align-self: center;
            }
            
            .glass-card .flex.items-center.justify-between > div:last-child {
                align-self: center;
                justify-content: center;
            }
            
            #metrics-block .flex.items-start.space-x-8 {
                flex-direction: column;
                gap: 1.5rem;
                padding-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="flex min-h-screen">
        <!-- Sidebar Container -->
        <div id="sidebar-container"></div>
        
        <!-- Main Content -->
        <div class="flex-1 ml-64 p-8">
            <!-- Кнопка начала встречи и секундомер -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <button id="change-employee-btn" class="glass-button glass-button-primary px-3 py-2 text-sm flex items-center justify-center" onclick="changeEmployee()" title="Сменить сотрудника">
                        <i data-feather="refresh-cw" class="w-3.5 h-3.5"></i>
                    </button>
                    
                    <button id="start-meeting-btn" class="glass-button glass-button-primary px-4 py-2 text-sm flex items-center justify-center" onclick="startMeeting()">
                        Начать встречу
                    </button>
                    
                    <!-- Секундомер -->
                    <div id="timer-display" class="text-sm text-gray-500 font-mono">
                        <span id="timer-text">00:00:00</span>
                    </div>
                </div>
            </div>
            
            <!-- Профиль сотрудника -->
            <div class="glass-card p-4 mb-6">
                <div class="flex items-center justify-between">
                    <!-- Левая часть: Аватар и информация -->
                    <div class="flex items-center">
                        <!-- Аватар -->
                        <img id="employee-avatar" src="" alt="Загрузка..." class="w-12 h-12 rounded-full">
                        
                    <!-- Информация о сотруднике -->
                    <div class="ml-4">
                        <h3 id="employee-name" class="font-semibold">Загрузка...</h3>
                        <p id="employee-position" class="text-sm text-gray-600">Загрузка...</p>
                    </div>
                </div>
                
                <!-- Метрики сотрудника -->
                <div class="flex items-center space-x-12">
                    <!-- Важность сотрудника -->
                    <div class="flex items-center space-x-3">
                        <div class="relative w-9 h-9 flex-shrink-0">
                            <svg class="w-9 h-9 transform -rotate-90" viewBox="0 0 36 36">
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                                      fill="none" stroke="#e5e7eb" stroke-width="2"/>
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                                      fill="none" stroke="var(--accent-purple)" stroke-width="2" 
                                      stroke-dasharray="78, 100" stroke-linecap="round"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-sm font-semibold text-primary">7.8</span>
                            </div>
                        </div>
                        <div class="text-sm text-secondary">
                            <div>Важность</div>
                        </div>
                    </div>
                    
                    <!-- Счастье сотрудника -->
                    <div class="flex items-center space-x-3">
                        <div class="relative w-9 h-9 flex-shrink-0">
                            <svg class="w-9 h-9 transform -rotate-90" viewBox="0 0 36 36">
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                                      fill="none" stroke="#e5e7eb" stroke-width="2"/>
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                                      fill="none" stroke="var(--primary-blue)" stroke-width="2" 
                                      stroke-dasharray="85, 100" stroke-linecap="round"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-sm font-semibold text-primary">8.5</span>
                            </div>
                        </div>
                        <div class="text-sm text-secondary">
                            <div>Счастье</div>
                        </div>
                    </div>
                </div>
                
                <!-- Теги сотрудника -->
                <div class="px-2 flex flex-col justify-center">
                    <div class="flex flex-wrap gap-2 mb-2">
                        <span class="employee-tag team-tag">Команда контента</span>
                        <span class="employee-tag experience-tag">3 года в команде</span>
                        <span class="employee-tag skill-tag">Бизнес-анализ</span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <span class="employee-tag motivator-tag">Деньги</span>
                        <span class="employee-tag activity-tag">Исполнительность</span>
                    </div>
                </div>
                </div>
            </div>

            <!-- Main Content Grid: AI Assistant (1/3) + Notes/Agreements (2/3) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- AI Assistant Chat - Left 1/3 -->
                <div class="glass-card p-6 flex flex-col h-[520px]" id="ai-chat-block">
                    <h2 class="text-xl font-semibold mb-4">AI-ассистент</h2>
                    
                    <!-- Chat Messages -->
                    <div class="flex-1 overflow-y-auto mb-4 space-y-3" id="chat-messages">
                        <!-- AI Message -->
                        <div class="text-sm max-w-xs">
                            Привет! Я готов помочь вам провести эффективную встречу с Анной. Вот несколько рекомендаций:
                        </div>
                        
                        <!-- Suggestion Buttons -->
                        <div class="space-y-2">
                            <button class="bg-primary text-white py-2 text-left text-xs inline-block hover:bg-primary/90 hover:shadow-lg transition-all duration-200" style="border-radius: 0px 25px 25px 25px; padding-left: 10px; padding-right: 15px;" onclick="sendSuggestion('Какие задачи вызывают у вас трудности?')">
                                Какие задачи вызывают у вас трудности?
                            </button>
                            <button class="bg-primary text-white py-2 text-left text-xs inline-block hover:bg-primary/90 hover:shadow-lg transition-all duration-200" style="border-radius: 0px 25px 25px 25px; padding-left: 10px; padding-right: 15px;" onclick="sendSuggestion('Расскажите о ваших карьерных планах')">
                                Расскажите о ваших карьерных планах
                            </button>
                            <button class="bg-primary text-white py-2 text-left text-xs inline-block hover:bg-primary/90 hover:shadow-lg transition-all duration-200" style="border-radius: 0px 25px 25px 25px; padding-left: 10px; padding-right: 15px;" onclick="sendSuggestion('Сгенерировать отчет о встрече')">
                                Сгенерировать отчет о встрече
                            </button>
                        </div>
                        
                        <!-- AI Message 2 -->
                        <div class="text-sm max-w-xs">
                            Анализ показывает рост удовлетворенности сотрудника на 12% за последние 3 месяца. Рекомендую обсудить факторы успеха.
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="chat-input"
                            class="glass-input glass-input-primary flex-1 text-sm" 
                            placeholder="Напишите сообщение..."
                            onkeypress="handleChatKeypress(event)">
                        <button 
                            class="glass-button glass-button-primary px-3 py-2"
                            onclick="sendMessage()">
                            <svg class="w-4 h-4 rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Notes and Agreements Block - Right 2/3 -->
                <div class="lg:col-span-2 glass-card p-6 flex flex-col" id="notes-agreements-block">
                    <!-- Notes Section -->
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold mb-4">Заметки</h2>
                        <textarea 
                            id="meeting-notes" 
                            class="glass-input w-full h-60 resize-none" 
                            placeholder="Записывайте ключевые моменты встречи, обратную связь от сотрудника и ваши наблюдения..."
                            disabled></textarea>
                    </div>
                    
                    <!-- Agreements Section -->
                    <div class="flex-1 flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold">Договоренности</h2>
                            <button class="glass-button px-3 py-1 text-sm" onclick="addNewAgreement()">
                                + Добавить пункт
                            </button>
                        </div>
                        
                        <!-- Agreements List -->
                        <div id="agreements-list" class="mb-4">
                            <!-- Договоренности будут загружены автоматически -->
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="shared/ui/sidebar.js"></script>
    <script src="shared/ui/modal.js"></script>
    <script src="shared/ui/employee-selector-modal.js"></script>
    
    <script>
        // Agreements functionality
        async function addNewAgreement() {
            // Проверяем, что встреча активна
            if (!isRunning) {
                alert('Договоренности можно добавлять только во время активной встречи. Нажмите "Начать встречу" чтобы начать.');
                return;
            }
            
            // Сохраняем все редактируемые пункты перед добавлением нового
            await saveAllEditingAgreements();
            
            const agreementsList = document.getElementById('agreements-list');
            
            // Проверяем, есть ли заглушка, и удаляем её
            const placeholder = agreementsList.querySelector('.text-center.py-8.text-gray-500');
            if (placeholder) {
                placeholder.remove();
            }
            
            const newAgreement = document.createElement('div');
            newAgreement.className = 'flex items-center space-x-3 p-2 bg-glass rounded editing';
            
            // Получаем завтрашнюю дату по умолчанию
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const defaultDate = tomorrow.toISOString().split('T')[0];
            
            newAgreement.innerHTML = `
                <input type="checkbox" class="custom-checkbox">
                <input type="text" class="text-sm font-medium flex-1 bg-transparent border-none outline-none" 
                       placeholder="Введите задачу..." onkeypress="handleTaskKeypress(event, this)">
                <input type="date" class="text-xs text-muted bg-transparent border-none outline-none" 
                       value="${defaultDate}">
                <select class="text-xs bg-primary/20 text-primary px-2 py-0.5 rounded border-none outline-none">
                    <option value="employee" class="bg-white text-black">Сотрудник</option>
                    <option value="manager" class="bg-white text-black">Руководитель</option>
                </select>
                <button onclick="removeAgreement(this)" class="text-xs text-red-500 hover:text-red-700 ml-2">✕</button>
            `;
            
            agreementsList.appendChild(newAgreement);
            
            // Фокус на поле задачи
            const taskInput = newAgreement.querySelector('input[type="text"]');
            taskInput.focus();
            
            // Инициализируем стиль select'а
            const selectElement = newAgreement.querySelector('select');
            updateResponsibleSelectStyle(selectElement);
        }
        
        function handleTaskKeypress(event, input) {
            if (event.key === 'Enter') {
                // При нажатии Enter просто убираем фокус, но не сохраняем сразу
                input.blur();
                // Сохранение произойдет при клике вне области
            }
        }
        
        async function saveTaskText(input) {
            const agreementElement = input.closest('.flex');
            
            if (input.value.trim() === '') {
                // Если задача пустая, удаляем пункт
                agreementElement.remove();
                
                // Проверяем, остались ли пункты. Если нет - показываем заглушку
                const agreementsList = document.getElementById('agreements-list');
                const remainingAgreements = agreementsList.querySelectorAll('.flex.items-center.space-x-3:not(.text-center)');
                if (remainingAgreements.length === 0) {
                    showAgreementsPlaceholder();
                }
            } else {
                // Просто убираем режим редактирования, не сохраняя пока
                // Сохранение произойдет при клике вне или явном сохранении
                console.log('Текст введен, ожидаем завершения редактирования');
            }
        }
        
        async function saveAgreementItem(agreementElement) {
            const taskInput = agreementElement.querySelector('input[type="text"]');
            const dateInput = agreementElement.querySelector('input[type="date"]');
            const responsibleSelect = agreementElement.querySelector('select');
            const removeButton = agreementElement.querySelector('button');
            
            if (taskInput.value.trim() === '') {
                return; // Не сохраняем пустые задачи
            }
            
            const task = taskInput.value;
            const responsible = responsibleSelect.value;
            const agreementType = responsible === 'employee' ? 'employee_task' : 'manager_task';
            const dueDate = dateInput.value;
            
            let savedAgreement = null;
            
            // НОВАЯ ЛОГИКА: Сохраняем через новый API
            if (currentMeetingId) {
                savedAgreement = await createAgreement(task, agreementType, dueDate);
                if (!savedAgreement) {
                    alert('Ошибка сохранения договоренности на сервер');
                    return;
                }
            }
            
            // Убираем класс редактирования
            agreementElement.classList.remove('editing');
            
            // Конвертируем в обычный вид
            const createdDate = new Date().toLocaleDateString('ru-RU');
            const dueDateFormatted = dateInput.value ? new Date(dateInput.value).toLocaleDateString('ru-RU') : '';
            const responsibleText = responsible === 'employee' ? 'Сотрудник' : 'Руководитель';
            const responsibleClass = responsible === 'employee' ? 'bg-primary/20 text-primary' : 'bg-accent-green/20 text-accent-green';
            
            const agreementId = savedAgreement ? savedAgreement.id : `temp-${Date.now()}`;
            
            agreementElement.innerHTML = `
                <input type="checkbox" class="custom-checkbox" data-agreement-id="${agreementId}">
                <span class="text-sm font-medium flex-1">${task}</span>
                <div class="text-xs flex flex-col space-y-1">
                    <span class="text-muted">Создано: ${createdDate}</span>
                    ${dueDateFormatted ? `<span class="text-blue-600 font-medium">До: ${dueDateFormatted}</span>` : ''}
                </div>
                <span class="text-xs ${responsibleClass} px-2 py-0.5 rounded">${responsibleText}</span>
            `;
            
            // ЕДИНАЯ ЛОГИКА настройки чекбокса (исправляет БАГ #3 - дублирование)
            setupAgreementCheckbox(agreementElement, savedAgreement, isRunning);
        }
        
        async function saveAllEditingAgreements() {
            const editingAgreements = document.querySelectorAll('.editing');
            for (const agreement of editingAgreements) {
                const taskInput = agreement.querySelector('input[type="text"]');
                if (taskInput && taskInput.value.trim() !== '') {
                    // Сохраняем только пункты с заполненным текстом
                    await saveAgreementItem(agreement);
                } else if (taskInput && taskInput.value.trim() === '') {
                    // Удаляем пустые пункты
                    agreement.remove();
                }
            }
            
            // Проверяем, остались ли пункты. Если нет - показываем заглушку
            const agreementsList = document.getElementById('agreements-list');
            const remainingAgreements = agreementsList.querySelectorAll('.flex.items-center.space-x-3:not(.text-center)');
            if (remainingAgreements.length === 0) {
                showAgreementsPlaceholder();
            }
        }
        
        function updateResponsibleSelectStyle(select) {
            const isEmployee = select.value === 'employee';
            select.className = `text-xs px-2 py-0.5 rounded border-none outline-none ${
                isEmployee ? 'bg-primary/20 text-primary' : 'bg-accent-green/20 text-accent-green'
            }`;
        }
        
        function removeAgreement(button) {
            button.closest('.flex').remove();
            
            // Проверяем, остались ли пункты. Если нет - показываем заглушку
            const agreementsList = document.getElementById('agreements-list');
            const remainingAgreements = agreementsList.querySelectorAll('.flex.items-center.space-x-3:not(.text-center)');
            if (remainingAgreements.length === 0) {
                showAgreementsPlaceholder();
            }
        }
        
        // Автосохранение при клике вне области редактирования
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.addEventListener('click', async function(event) {
                    // ИСПРАВЛЯЕМ БАГ #5: Исключаем чекбоксы договоренностей от автосохранения
                    if (event.target.closest('button') || 
                        event.target.closest('input') || 
                        event.target.closest('select') ||
                        event.target.closest('.editing') ||
                        event.target.matches('input[type="checkbox"].custom-checkbox')) { // НОВОЕ: исключаем чекбоксы
                        return;
                    }
                    
                    // Сохраняем все редактируемые пункты с заполненным текстом
                    await saveAllEditingAgreements();
                });
            }, 100);
            
            // Добавляем обработчики для изменения select'ов
            document.addEventListener('change', function(event) {
                if (event.target.tagName === 'SELECT' && event.target.closest('.editing')) {
                    updateResponsibleSelectStyle(event.target);
                }
            });
        });
        
        // Chat functionality
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message === '') return;
            
            // Добавляем сообщение пользователя
            addUserMessage(message);
            
            // Очищаем поле ввода
            input.value = '';
            
            // Симулируем ответ AI через короткую задержку
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                addAIMessage(aiResponse);
            }, 1000);
        }
        
        function sendSuggestion(suggestion) {
            addUserMessage(suggestion);
            
            // Симулируем ответ AI
            setTimeout(() => {
                let response = '';
                if (suggestion.includes('трудности')) {
                    response = 'Отличный вопрос! Это поможет выявить препятствия в работе. Рекомендую также спросить: "Какая поддержка от команды или руководства поможет вам справиться с этими трудностями?"';
                } else if (suggestion.includes('карьерные планы')) {
                    response = 'Важная тема для развития! После этого можно обсудить: "Какие навыки вы хотели бы развить в ближайшие 6 месяцев?" и "Как я могу помочь вам в достижении ваших целей?"';
                } else if (suggestion.includes('отчет')) {
                    response = 'Готовлю отчет о встрече на основе введенных заметок и договоренностей. Отчет будет содержать основные темы, выводы и план действий.';
                } else {
                    response = 'Понял ваш запрос. Могу предложить дополнительные вопросы или рекомендации для эффективного проведения встречи.';
                }
                addAIMessage(response);
            }, 1000);
        }
        
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function addUserMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end';
            
            messageDiv.innerHTML = `
                <div class="text-primary text-sm max-w-xs text-right">
                    ${message}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function addAIMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'text-sm max-w-xs';
            messageDiv.textContent = message;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function generateAIResponse(userMessage) {
            const responses = [
                'Интересная мысль! Это может быть полезно для развития команды.',
                'Рекомендую зафиксировать это в договоренностях для дальнейшего отслеживания.',
                'Хороший подход! Можно также рассмотреть альтернативные варианты.',
                'Это поможет улучшить взаимодействие в команде. Стоит обсудить детали.',
                'Отличная идея для повышения эффективности работы!'
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Функциональность секундомера
        let timerInterval = null;
        let startTime = null;
        let isRunning = false;
        
        async function startMeeting() {
            console.log('startMeeting вызвана. isRunning:', isRunning, 'currentEmployee:', currentEmployee);
            const btn = document.getElementById('start-meeting-btn');
            const timerText = document.getElementById('timer-text');
            console.log('Элементы кнопки найдены:', { btn: !!btn, timerText: !!timerText });
            
            if (!isRunning) {
                // Проверяем, что выбран сотрудник
                if (!currentEmployee) {
                    alert('Пожалуйста, выберите сотрудника для встречи');
                    return;
                }
                
                try {
                    // Блокируем кнопку во время запроса
                    btn.disabled = true;
                    btn.textContent = 'Создание встречи...';
                    
                    // Создаем встречу через API
                    const response = await fetch('http://localhost:3001/api/meetings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            employeeId: currentEmployee.id
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.message || 'Ошибка создания встречи');
                    }
                    
                    if (result.success) {
                        // Сохраняем ID созданной встречи
                        currentMeetingId = result.data.id;
                        console.log('Встреча создана с ID:', currentMeetingId);
                        
                        // Начинаем встречу через API
                        const startResponse = await fetch(`http://localhost:3001/api/meetings/${currentMeetingId}/start`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const startResult = await startResponse.json();
                        
                        if (!startResponse.ok) {
                            throw new Error(startResult.message || 'Ошибка начала встречи');
                        }
                        
                        if (startResult.success) {
                            // Запускаем секундомер
                            startTime = Date.now();
                            isRunning = true;
                            
                            // Запускаем автосохранение
                            startAutoSave();
                            
                            // Меняем текст кнопки
                            btn.textContent = 'Завершить встречу';
                            btn.disabled = false;
                            
                            // Обновляем состояние кнопки "Сменить сотрудника"
                            updateChangeEmployeeButton();
                            
                            // Обновляем состояние поля заметок
                            updateNotesFieldState();
                            
                            // Обновляем состояние области договоренностей
                            updateAgreementsFieldState();
                            
                            // НОВАЯ ЛОГИКА: Загружаем открытые договоренности
                            await loadOpenAgreements(currentEmployee.id);
                            
                            // Перерисовываем иконки Feather
                            feather.replace();
                            
                            // Запускаем интервал обновления
                            timerInterval = setInterval(updateTimer, 1000);
                            updateTimer(); // Сразу обновляем
                            
                            console.log('Встреча успешно начата');
                        }
                    }
                    
                } catch (error) {
                    console.error('Ошибка при создании/начале встречи:', error);
                    alert(`Ошибка: ${error.message}`);
                    
                    // Возвращаем кнопку в исходное состояние
                    btn.textContent = 'Начать встречу';
                    btn.disabled = false;
                }
                
            } else {
                // Завершаем встречу
                try {
                    // Блокируем кнопку во время запроса
                    btn.disabled = true;
                    btn.textContent = 'Завершение встречи...';
                    
                    if (currentMeetingId) {
                        // Завершаем встречу через API
                        const response = await fetch(`http://localhost:3001/api/meetings/${currentMeetingId}/end`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                notes: document.getElementById('meeting-notes')?.value || ''
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.message || 'Ошибка завершения встречи');
                        }
                        
                        if (result.success) {
                            console.log('Встреча успешно завершена');
                        }
                    }
                    
                    // Останавливаем секундомер и автосохранение
                    isRunning = false;
                    clearInterval(timerInterval);
                    stopAutoSave();
                    
                    // Возвращаем исходный текст кнопки
                    btn.textContent = 'Начать встречу';
                    btn.disabled = false;
                    
                    // Обновляем состояние кнопки "Сменить сотрудника"
                    updateChangeEmployeeButton();
                    
                    // Обновляем состояние поля заметок
                    updateNotesFieldState();
                    
                    // Обновляем состояние области договоренностей
                    updateAgreementsFieldState();
                    
                    // Перерисовываем иконки Feather
                    feather.replace();
                    
                    // Сбрасываем таймер
                    timerText.textContent = '00:00:00';
                    
                    // Сбрасываем ID встречи
                    currentMeetingId = null;
                    
                } catch (error) {
                    console.error('Ошибка при завершении встречи:', error);
                    alert(`Ошибка завершения встречи: ${error.message}`);
                    
                    // В случае ошибки всё равно останавливаем локальный таймер и автосохранение
                    isRunning = false;
                    clearInterval(timerInterval);
                    stopAutoSave();
                    btn.textContent = 'Начать встречу';
                    btn.disabled = false;
                    timerText.textContent = '00:00:00';
                    
                    // Обновляем состояние кнопки "Сменить сотрудника"
                    updateChangeEmployeeButton();
                    
                    // Обновляем состояние поля заметок
                    updateNotesFieldState();
                    
                    // Обновляем состояние области договоренностей
                    updateAgreementsFieldState();
                }
            }
        }
        
        function updateTimer() {
            if (!isRunning || !startTime) return;
            
            const elapsed = Date.now() - startTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            const formatNumber = (num) => num.toString().padStart(2, '0');
            
            const timerText = document.getElementById('timer-text');
            timerText.textContent = `${formatNumber(hours)}:${formatNumber(minutes % 60)}:${formatNumber(seconds % 60)}`;
        }
        
        // Переменная для хранения данных текущего сотрудника
        let currentEmployee = null;
        
        // Переменная для хранения ID текущей встречи
        let currentMeetingId = null;

        // Глобальная переменная для модального окна выбора сотрудника
        let employeeSelectorModal = null;

        // Переменные для автосохранения
        let autoSaveInterval = null;
        let lastSavedNotes = '';
        let hasUnsavedChanges = false;

        // Функция загрузки сотрудника при инициализации
        async function loadEmployee() {
            // Проверяем URL параметры
            const urlParams = new URLSearchParams(window.location.search);
            const employeeId = urlParams.get('employeeId');
            const meetingId = urlParams.get('meetingId');
            
            console.log('Инициализация страницы. URL params:', { employeeId, meetingId });
            
            if (employeeId) {
                console.log('Загружаем сотрудника по ID из URL:', employeeId);
                await loadEmployeeById(employeeId);
                if (meetingId) {
                    currentMeetingId = meetingId;
                    console.log('ID встречи из URL:', meetingId);
                    // Проверяем активную встречу и инициализируем таймер
                    await checkAndInitializeActiveMeeting();
                }
            } else {
                // Загружаем первого сотрудника по умолчанию
                await loadDefaultEmployee();
                // Проверяем, есть ли активная встреча в системе
                await checkAndInitializeActiveMeeting({ type: 'currentEmployeeOnly' });
            }
        }

        // Функция загрузки конкретного сотрудника по ID
        async function loadEmployeeById(employeeId) {
            try {
                const response = await fetch(`http://localhost:3001/api/employees/${employeeId}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    currentEmployee = result.data;
                    updateCurrentEmployee(currentEmployee);
                    console.log('Сотрудник загружен по ID:', currentEmployee);
                    
                    // Проверяем активную встречу для этого сотрудника
                    await checkAndInitializeActiveMeeting({ type: 'byEmployeeId', employeeId: employeeId });
                } else {
                    console.error('Сотрудник не найден:', employeeId);
                    // Загружаем первого сотрудника по умолчанию
                    await loadDefaultEmployee();
                }
            } catch (error) {
                console.error('Ошибка загрузки сотрудника по ID:', error);
                // Загружаем первого сотрудника по умолчанию
                await loadDefaultEmployee();
            }
        }

        // Функция загрузки первого сотрудника при инициализации
        async function loadDefaultEmployee() {
            try {
                // Сначала проверяем, есть ли активная встреча в системе
                await checkAndInitializeActiveMeeting({ type: 'anyActive', changeEmployee: true });
                
                // Если активной встречи нет, загружаем первого сотрудника
                if (!currentEmployee) {
                    const response = await fetch('http://localhost:3001/api/employees');
                    const result = await response.json();
                    
                    if (result.success && result.data.length > 0) {
                        currentEmployee = result.data[0]; // Берем первого сотрудника
                        updateCurrentEmployee(currentEmployee);
                        
                        // Проверяем активную встречу для этого сотрудника
                        await checkAndInitializeActiveMeeting({ type: 'byEmployeeId', employeeId: currentEmployee.id });
                    } else {
                        // Если нет сотрудников, показываем заглушку для договоренностей
                        showAgreementsPlaceholder();
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки сотрудника по умолчанию:', error);
                showAgreementsPlaceholder();
            }
        }

        // Функция смены сотрудника
        function changeEmployee() {
            // Проверяем, не идет ли сейчас встреча
            if (isRunning) {
                alert('Нельзя менять сотрудника во время активной встречи. Сначала завершите текущую встречу.');
                return;
            }
            
            // Создаем и открываем модальное окно для выбора сотрудника
            employeeSelectorModal = new EmployeeSelectorModal({
                title: 'Выберите сотрудника для встречи',
                currentEmployeeId: currentEmployee ? currentEmployee.id : null,
                onEmployeeSelect: (selectedEmployee) => {
                    updateCurrentEmployee(selectedEmployee);
                },
                onClose: () => {
                    employeeSelectorModal = null;
                    window.currentEmployeeSelectorModal = null;
                }
            });
            
            // Устанавливаем глобальную ссылку для доступа из HTML
            window.currentEmployeeSelectorModal = employeeSelectorModal;
            
            employeeSelectorModal.open();
        }

        /**
         * Функция управления состоянием поля заметок
         */
        function updateNotesFieldState() {
            const notesTextarea = document.getElementById('meeting-notes');
            if (notesTextarea) {
                if (isRunning) {
                    // Во время встречи - включаем поле заметок
                    notesTextarea.disabled = false;
                    notesTextarea.placeholder = 'Записывайте ключевые моменты встречи, обратную связь от сотрудника и ваши наблюдения...';
                    notesTextarea.classList.remove('opacity-50');
                } else {
                    // Когда встреча не идет - отключаем поле заметок
                    notesTextarea.disabled = true;
                    notesTextarea.placeholder = 'Заметки доступны только во время активной встречи. Нажмите "Начать встречу" чтобы начать записывать.';
                    notesTextarea.classList.add('opacity-50');
                }
            }
        }

        /**
         * Функция управления состоянием области договоренностей
         */
        function updateAgreementsFieldState() {
            // Управляем кнопкой "Добавить пункт"
            const addAgreementButton = document.querySelector('#notes-agreements-block button[onclick="addNewAgreement()"]');
            if (addAgreementButton) {
                if (isRunning) {
                    // Во время встречи - включаем кнопку добавления
                    addAgreementButton.disabled = false;
                    addAgreementButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    addAgreementButton.title = 'Добавить пункт';
                } else {
                    // Когда встреча не идет - отключаем кнопку добавления
                    addAgreementButton.disabled = true;
                    addAgreementButton.classList.add('opacity-50', 'cursor-not-allowed');
                    addAgreementButton.title = 'Договоренности доступны только во время активной встречи';
                }
            }

            // Управляем всеми чекбоксами в договоренностях
            const agreementCheckboxes = document.querySelectorAll('#agreements-list .custom-checkbox');
            agreementCheckboxes.forEach(checkbox => {
                if (isRunning) {
                    // Во время встречи - включаем чекбоксы
                    checkbox.disabled = false;
                    checkbox.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    // Когда встреча не идет - отключаем чекбоксы
                    checkbox.disabled = true;
                    checkbox.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });

            // Управляем кнопками удаления в редактируемых пунктах
            const removeButtons = document.querySelectorAll('#agreements-list .editing button[onclick*="removeAgreement"]');
            removeButtons.forEach(button => {
                if (isRunning) {
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        /**
         * Функция обновления состояния кнопки "Сменить сотрудника"
         */
        function updateChangeEmployeeButton() {
            const changeBtn = document.getElementById('change-employee-btn');
            if (changeBtn) {
                if (isRunning) {
                    // Во время встречи - дизейблим кнопку
                    changeBtn.disabled = true;
                    changeBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    changeBtn.title = 'Нельзя менять сотрудника во время активной встречи';
                } else {
                    // Когда встреча не идет - возвращаем активное состояние
                    changeBtn.disabled = false;
                    changeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    changeBtn.title = 'Сменить сотрудника';
                }
            }
        }

        // Функция обновления отображения текущего сотрудника
        function updateCurrentEmployee(employee) {
            console.log('updateCurrentEmployee вызвана с:', employee);
            currentEmployee = employee;
            
            // Обновляем аватар
            const avatarImg = document.getElementById('employee-avatar');
            console.log('Элемент employee-avatar найден:', !!avatarImg);
            if (avatarImg) {
                if (employee.photoUrl) {
                    avatarImg.src = employee.photoUrl;
                } else {
                    // Создаем аватар с инициалами
                    const initials = `${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}`;
                    const color = generateAvatarColor(employee.first_name + employee.last_name);
                    avatarImg.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50'%3E%3Ccircle cx='25' cy='25' r='25' fill='%23${color}'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='white' font-family='Arial' font-size='12'%3E${initials}%3C/text%3E%3C/svg%3E`;
                }
                avatarImg.alt = `${employee.first_name} ${employee.last_name}`;
            }
            
            // Обновляем имя и должность
            const nameElement = document.getElementById('employee-name');
            console.log('Элемент employee-name найден:', !!nameElement);
            if (nameElement) {
                const fullName = `${employee.first_name} ${employee.last_name}`;
                nameElement.textContent = fullName;
                console.log('Имя обновлено:', fullName);
            }
            
            const positionElement = document.getElementById('employee-position');
            console.log('Элемент employee-position найден:', !!positionElement);
            if (positionElement) {
                positionElement.textContent = employee.position;
                console.log('Должность обновлена:', employee.position);
            }
            
            // Очищаем текущие заметки и договоренности только если встреча не активна
            if (!isRunning) {
                clearNotesAndAgreements();
                // НОВАЯ ЛОГИКА: Загружаем открытые договоренности из таблицы
                loadOpenAgreements(employee.id);
            }
            
            console.log('Сотрудник изменен на:', employee);
        }

        // Функция генерации цвета аватара на основе имени
        function generateAvatarColor(name) {
            const colors = [
                '4A90E2', '50E3C2', '9013FE', 'F5A623',
                'D0021B', '7ED321', 'BD10E0', 'B8E986',
                '9B9B9B', 'F8E71C', '8B572A', '417505'
            ];
            
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const selectedColor = colors[Math.abs(hash) % colors.length];
            console.log(`Цвет для "${name}": ${selectedColor} (хеш: ${hash})`);
            
            return selectedColor;
        }

        /**
         * Глобальная функция для обработки клика на "Встреча" в сайдбаре
         * На странице встречи ничего не делаем
         */
        function startMeetingFromSidebar(event) {
            event.preventDefault();
            // На странице встречи ничего не делаем - остаемся где были
            console.log('Уже на странице встречи');
        }

        /**
         * НОВАЯ ЛОГИКА: Загрузка открытых договоренностей из таблицы (без копирования!)
         */
        async function loadOpenAgreements(employeeId) {
            if (!employeeId) {
                console.log('Не указан ID сотрудника для загрузки договоренностей');
                showAgreementsPlaceholder();
                return;
            }
            
            try {
                console.log(`📋 Загружаем открытые договоренности для сотрудника: ${employeeId}`);
                const response = await fetch(`http://localhost:3001/api/employees/${employeeId}/agreements/open`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const { agreements } = result.data;
                    
                    if (agreements && agreements.length > 0) {
                        console.log(`✅ Найдено ${agreements.length} открытых договоренностей`);
                        renderAgreements(agreements);
                    } else {
                        console.log('📭 Нет открытых договоренностей');
                        showAgreementsPlaceholder();
                    }
                } else {
                    console.error('❌ Ошибка загрузки открытых договоренностей:', result.message);
                    showAgreementsPlaceholder();
                }
            } catch (error) {
                console.error('❌ Ошибка при загрузке открытых договоренностей:', error);
                showAgreementsPlaceholder();
            }
        }

        /**
         * НОВАЯ ЛОГИКА: Создание договоренности через новый API
         */
        async function createAgreement(title, responsibleType, dueDate) {
            if (!currentMeetingId || !currentEmployee) {
                console.error('Нет активной встречи или сотрудника');
                return null;
            }
            
            try {
                const response = await fetch('http://localhost:3001/api/agreements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        meeting_id: currentMeetingId,
                        employee_id: currentEmployee.id,
                        title: title,
                        responsible_type: responsibleType,
                        due_date: dueDate || null
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    console.log('✅ Договоренность создана:', result.data);
                    return result.data;
                } else {
                    console.error('❌ Ошибка создания договоренности:', result);
                    return null;
                }
            } catch (error) {
                console.error('❌ Ошибка при создании договоренности:', error);
                return null;
            }
        }

        /**
         * НОВАЯ ЛОГИКА: Обновление статуса договоренности
         */
        async function updateAgreementStatus(agreementId, status) {
            try {
                const response = await fetch(`http://localhost:3001/api/agreements/${agreementId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    console.log('✅ Статус договоренности обновлен:', result.data);
                    return result.data;
                } else {
                    console.error('❌ Ошибка обновления статуса:', result);
                    return null;
                }
            } catch (error) {
                console.error('❌ Ошибка при обновлении статуса:', error);
                return null;
            }
        }

        /**
         * Функция для сохранения заметок на сервер
         */
        async function saveNotesToServer(notes) {
            if (!currentMeetingId || !notes.trim()) {
                return; // Не сохраняем пустые заметки или если нет активной встречи
            }
            
            try {
                const response = await fetch(`http://localhost:3001/api/meetings/${currentMeetingId}/notes`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notes: notes
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    lastSavedNotes = notes;
                    hasUnsavedChanges = false;
                    console.log('✅ Заметки автоматически сохранены');
                } else {
                    console.error('❌ Ошибка сохранения заметок:', result.message);
                }
            } catch (error) {
                console.error('Ошибка при сохранении заметок:', error);
            }
        }

        /**
         * Запуск автосохранения каждые 5 секунд
         */
        function startAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            autoSaveInterval = setInterval(async () => {
                if (!isRunning || !currentMeetingId) {
                    return;
                }
                
                const notesTextarea = document.getElementById('meeting-notes');
                if (notesTextarea) {
                    const currentNotes = notesTextarea.value;
                    
                    // Сохраняем только если есть изменения
                    if (currentNotes !== lastSavedNotes && currentNotes.trim()) {
                        console.log('🔄 Автосохранение заметок...');
                        await saveNotesToServer(currentNotes);
                        hasUnsavedChanges = false;
                    }
                }
            }, 5000); // Каждые 5 секунд
            
            console.log('🚀 Автосохранение запущено (каждые 5 секунд)');
        }

        /**
         * Остановка автосохранения
         */
        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
                console.log('⏹️ Автосохранение остановлено');
            }
        }

        /**
         * Сохранение при потере фокуса страницы
         */
        function setupVisibilityChangeHandler() {
            document.addEventListener('visibilitychange', async () => {
                if (document.hidden && isRunning && currentMeetingId) {
                    // Страница теряет фокус - сохраняем немедленно
                    const notesTextarea = document.getElementById('meeting-notes');
                    if (notesTextarea && notesTextarea.value !== lastSavedNotes) {
                        console.log('🌙 Страница теряет фокус - сохраняем заметки');
                        await saveNotesToServer(notesTextarea.value);
                    }
                }
            });
            
            // Также сохраняем при закрытии страницы
            window.addEventListener('beforeunload', async (e) => {
                if (isRunning && currentMeetingId && hasUnsavedChanges) {
                    const notesTextarea = document.getElementById('meeting-notes');
                    if (notesTextarea && notesTextarea.value !== lastSavedNotes) {
                        // Синхронный запрос для гарантии сохранения
                        navigator.sendBeacon(
                            `http://localhost:3001/api/meetings/${currentMeetingId}/notes`,
                            JSON.stringify({ notes: notesTextarea.value })
                        );
                    }
                }
            });
        }


        /**
         * НОВАЯ: Централизованная функция настройки чекбокса (исправляет БАГ #3)
         * Сохраняет ВСЕ возможности: включение/отключение, обработчики событий, визуальные состояния
         */
        function setupAgreementCheckbox(agreementElement, savedAgreement, meetingIsRunning) {
            const checkbox = agreementElement.querySelector('input[type="checkbox"]');
            if (!checkbox) {
                console.warn('Чекбокс не найден в элементе договоренности');
                return;
            }
            
            // ЛОГИКА 1: Встреча НЕ активна - чекбокс отключен (сохраняем существующее поведение)
            if (!meetingIsRunning) {
                checkbox.disabled = true;
                checkbox.classList.add('opacity-50', 'cursor-not-allowed');
                console.log('Встреча неактивна - чекбокс отключен');
                return;
            }
            
            // ЛОГИКА 2: Встреча активна, но договоренность не сохранена - показываем процесс сохранения
            if (!savedAgreement) {
                checkbox.disabled = true;
                checkbox.classList.add('opacity-50', 'cursor-not-allowed');
                checkbox.title = 'Сохранение договоренности...';
                console.log('Договоренность еще не сохранена, чекбокс отключен');
                return;
            }
            
            // ЛОГИКА 3: Встреча активна и договоренность сохранена - полная функциональность
            checkbox.disabled = false;
            checkbox.classList.remove('opacity-50', 'cursor-not-allowed');
            checkbox.title = 'Отметить как выполненное / снять отметку';
            checkbox.setAttribute('data-agreement-id', savedAgreement.id);
            
            // Добавляем обработчик событий (сохраняем всю существующую логику)
            addCheckboxEventListener(checkbox, savedAgreement.id);
            
            console.log('Чекбокс полностью настроен для договоренности:', savedAgreement.id);
        }
        
        /**
         * Централизованная функция для добавления обработчика событий к чекбоксу
         */
        function addCheckboxEventListener(checkbox, agreementId) {
            if (!checkbox || !agreementId) {
                console.error('Неверные параметры для addCheckboxEventListener:', { checkbox: !!checkbox, agreementId });
                return;
            }
            
            // Удаляем старые обработчики событий, если они есть
            const newCheckbox = checkbox.cloneNode(true);
            checkbox.parentNode.replaceChild(newCheckbox, checkbox);
            
            // Добавляем новый обработчик
            newCheckbox.addEventListener('change', function() {
                console.log('Чекбокс кликнут:', { agreementId, checked: this.checked });
                handleAgreementStatusChange(agreementId, this.checked);
            });
            
            console.log('Обработчик событий добавлен для договоренности:', agreementId);
        }

        /**
         * НОВАЯ ЛОГИКА: Обработка изменения статуса договоренности
         */
        async function handleAgreementStatusChange(agreementId, isChecked) {
            console.log('📝 Изменение статуса договоренности:', { agreementId, isChecked });
            
            if (!agreementId) {
                console.error('Не указан ID договоренности');
                return;
            }
            
            // НОВАЯ ЛОГИКА СТАТУСОВ: pending ↔ marked_for_completion
            const newStatus = isChecked ? 'marked_for_completion' : 'pending';
            
            // Временно блокируем чекбокс во время запроса
            const checkbox = document.querySelector(`input[data-agreement-id="${agreementId}"]`);
            if (checkbox) {
                checkbox.disabled = true;
            }
            
            try {
                const updatedAgreement = await updateAgreementStatus(agreementId, newStatus);
                
                if (updatedAgreement) {
                    console.log('✅ Статус успешно обновлен');
                    // Обновляем отображение
                    updateAgreementDisplay(agreementId, newStatus, updatedAgreement);
                } else {
                    // Возвращаем чекбокс в исходное состояние
                    if (checkbox) {
                        checkbox.checked = !isChecked;
                    }
                    alert('Ошибка обновления статуса договоренности');
                }
            } catch (error) {
                console.error('❌ Ошибка при обновлении статуса договоренности:', error);
                // Возвращаем чекбокс в исходное состояние
                if (checkbox) {
                    checkbox.checked = !isChecked;
                }
                alert('Ошибка связи с сервером');
            } finally {
                // Разблокируем чекбокс
                if (checkbox) {
                    checkbox.disabled = false;
                }
            }
        }

        /**
         * НОВАЯ ЛОГИКА: Обновление отображения договоренности
         */
        function updateAgreementDisplay(agreementId, newStatus, updatedAgreement) {
            const checkbox = document.querySelector(`input[data-agreement-id="${agreementId}"]`);
            if (!checkbox) return;
            
            const agreementElement = checkbox.closest('.flex');
            if (!agreementElement) return;
            
            // Обновляем стиль текста в зависимости от статуса
            const titleSpan = agreementElement.querySelector('.text-sm.font-medium.flex-1');
            if (titleSpan) {
                if (newStatus === 'completed') {
                    titleSpan.style.textDecoration = 'line-through';
                    titleSpan.style.opacity = '0.7';
                } else if (newStatus === 'marked_for_completion') {
                    titleSpan.style.textDecoration = 'none';
                    titleSpan.style.opacity = '0.8';
                    titleSpan.style.fontStyle = 'italic';
                } else {
                    titleSpan.style.textDecoration = 'none';
                    titleSpan.style.opacity = '1';
                    titleSpan.style.fontStyle = 'normal';
                }
            }
            
            // Обновляем состояние чекбокса
            checkbox.checked = (newStatus === 'marked_for_completion' || newStatus === 'completed');
            
            console.log(`📝 Отображение договоренности ${agreementId} обновлено. Статус: ${newStatus}`);
        }

        /**
         * Функция очистки заметок и договоренностей
         */
        function clearNotesAndAgreements() {
            // Очищаем поле заметок
            const notesTextarea = document.getElementById('meeting-notes');
            if (notesTextarea) {
                notesTextarea.value = '';
            }
            
            // Очищаем список договоренностей (удаляем все существующие)
            const agreementsList = document.getElementById('agreements-list');
            if (agreementsList) {
                agreementsList.innerHTML = '';
            }
        }



        /**
         * Функция отображения заглушки для договоренностей
         */
        function showAgreementsPlaceholder() {
            const agreementsList = document.getElementById('agreements-list');
            if (agreementsList) {
                agreementsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="mb-2">
                            <svg class="w-12 h-12 mx-auto opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <p class="text-sm">Нет открытых договоренностей с последней встречи</p>
                        <p class="text-xs text-gray-400 mt-1">Добавьте новые договоренности в ходе встречи</p>
                    </div>
                `;
            }
        }

        /**
         * Функция отображения договоренностей из последней встречи
         */
        function renderAgreements(agreements) {
            const agreementsList = document.getElementById('agreements-list');
            if (!agreementsList) return;
            
            // Очищаем список
            agreementsList.innerHTML = '';
            
            agreements.forEach(agreement => {
                const agreementElement = document.createElement('div');
                agreementElement.className = 'flex items-center space-x-3 p-2 bg-glass rounded';
                
                // Определяем тип ответственного
                const isEmployee = agreement.type === 'employee_task';
                const responsibleText = isEmployee ? 'Сотрудник' : 'Руководитель';
                const responsibleClass = isEmployee ? 'bg-primary/20 text-primary' : 'bg-accent-green/20 text-accent-green';
                
                // Форматируем дату создания (если есть)
                let createdDateText = '';
                if (agreement.created_at) {
                    const date = new Date(agreement.created_at);
                    createdDateText = `Создано: ${date.toLocaleDateString('ru-RU')}`;
                }
                
                // Форматируем планируемую дату выполнения (если есть)
                let dueDateText = '';
                if (agreement.due_date) {
                    const dueDate = new Date(agreement.due_date);
                    dueDateText = `До: ${dueDate.toLocaleDateString('ru-RU')}`;
                }
                
                // Форматируем дату выполнения (если есть)
                let completedText = '';
                if (agreement.completed_at) {
                    const completedDate = new Date(agreement.completed_at);
                    completedText = `Выполнено: ${completedDate.toLocaleDateString('ru-RU')} ${completedDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}`;
                }
                
                // НОВАЯ ЛОГИКА: Определяем состояние задачи с учетом новых статусов
                const isCompleted = agreement.status === 'completed';
                const isMarked = agreement.status === 'marked_for_completion';
                const isChecked = isCompleted || isMarked;
                
                let taskStyle = '';
                if (isCompleted) {
                    taskStyle = 'text-decoration: line-through; opacity: 0.7;';
                } else if (isMarked) {
                    taskStyle = 'opacity: 0.8; font-style: italic;';
                }
                
                agreementElement.innerHTML = `
                    <input type="checkbox" class="custom-checkbox" ${isChecked ? 'checked' : ''}>
                    <span class="text-sm font-medium flex-1" style="${taskStyle}">${agreement.title}</span>
                    <div class="text-xs flex flex-col space-y-1">
                        ${createdDateText ? `<span class="text-muted">${createdDateText}</span>` : ''}
                        ${dueDateText ? `<span class="text-blue-600 font-medium">${dueDateText}</span>` : ''}
                        ${completedText ? `<span class="text-green-600">${completedText}</span>` : ''}
                    </div>
                    <span class="text-xs ${responsibleClass} px-2 py-0.5 rounded">${responsibleText}</span>
                `;
                
                // ИСПОЛЬЗУЕМ НОВУЮ централизованную логику настройки чекбокса
                setupAgreementCheckbox(agreementElement, agreement, isRunning);
                
                agreementsList.appendChild(agreementElement);
            });
        }

        /**
         * Восстановление контекста встречи (заметки и договоренности)
         */
        async function restoreMeetingContext(meeting) {
            console.log('Восстанавливаем контекст встречи:', meeting);
            
            try {
                // Восстанавливаем заметки
                if (meeting.content && meeting.content.notes) {
                    const notesTextarea = document.getElementById('meeting-notes');
                    if (notesTextarea) {
                        notesTextarea.value = meeting.content.notes;
                        lastSavedNotes = meeting.content.notes; // Инициализируем для автосохранения
                        hasUnsavedChanges = false;
                        console.log('Заметки восстановлены:', meeting.content.notes.substring(0, 50) + '...');
                    }
                }
                
                // Восстанавливаем договоренности
                if (meeting.content && meeting.content.agreements && Array.isArray(meeting.content.agreements)) {
                    console.log('Восстанавливаем договоренности:', meeting.content.agreements.length);
                    renderAgreements(meeting.content.agreements);
                }
                
                console.log('Контекст встречи полностью восстановлен');
            } catch (error) {
                console.error('Ошибка восстановления контекста встречи:', error);
            }
        }

        /**
         * УНИВЕРСАЛЬНАЯ функция проверки и инициализации активной встречи
         * Заменяет 4 дублирующие функции, сохраняя ВСЮ логику
         * 
         * @param {Object} options - Параметры поиска встречи
         * @param {string} options.type - Тип поиска: 'byMeetingId' | 'byEmployeeId' | 'anyActive' | 'currentEmployeeOnly'
         * @param {string} options.meetingId - ID конкретной встречи (для type: 'byMeetingId')
         * @param {string} options.employeeId - ID сотрудника (для type: 'byEmployeeId')
         * @param {boolean} options.changeEmployee - Менять ли сотрудника если найдена встреча с другим (по умолчанию false)
         */
        async function checkAndInitializeActiveMeeting(options = {}) {
            const { type = 'byMeetingId', meetingId, employeeId, changeEmployee = false } = options;
            
            console.log(`checkAndInitializeActiveMeeting вызвана. Тип: ${type}`, options);
            
            try {
                let meeting = null;
                let apiUrl = '';
                
                // ЛОГИКА 1: Поиск встречи по конкретному ID (было в checkAndInitializeActiveMeeting)
                if (type === 'byMeetingId') {
                    const targetMeetingId = meetingId || currentMeetingId;
                    if (!targetMeetingId) {
                        console.log('ID встречи не установлен, выходим');
                        return;
                    }
                    
                    apiUrl = `http://localhost:3001/api/meetings/${targetMeetingId}`;
                    console.log('Запрашиваем данные встречи:', apiUrl);
                    
                    const response = await fetch(apiUrl);
                    const result = await response.json();
                    
                    if (response.ok && result.success && result.data) {
                        meeting = result.data;
                        
                        // Проверяем, активна ли встреча
                        if (meeting.status === 'active' && meeting.started_at) {
                            console.log('Обнаружена активная встреча, инициализируем таймер');
                            currentMeetingId = meeting.id;
                        } else {
                            console.log('Встреча найдена, но не активна. Статус:', meeting.status);
                            return;
                        }
                    } else {
                        console.log('Встреча не найдена или не активна. Response:', response.status);
                        return;
                    }
                }
                
                // ЛОГИКА 2: Поиск активной встречи для конкретного сотрудника (было в checkEmployeeActiveMeeting)
                else if (type === 'byEmployeeId') {
                    if (!employeeId) {
                        console.log('ID сотрудника не указан');
                        return;
                    }
                    
                    console.log('Проверяем активную встречу для сотрудника:', employeeId);
                    apiUrl = `http://localhost:3001/api/meetings/active-for-employee/${employeeId}`;
                    
                    const response = await fetch(apiUrl);
                    const result = await response.json();
                    
                    if (response.ok && result.success && result.data) {
                        meeting = result.data;
                        console.log('Найдена активная встреча для сотрудника:', meeting);
                        currentMeetingId = meeting.id;
                    } else {
                        console.log('Активной встречи для сотрудника не найдено');
                        // Рекурсивно ищем любую активную встреча в системе
                        await checkAndInitializeActiveMeeting({ type: 'anyActive', changeEmployee: true });
                        return;
                    }
                }
                
                // ЛОГИКА 3: Поиск любой активной встречи в системе (было в checkForActiveMeetingInSystem)
                else if (type === 'anyActive') {
                    console.log('Проверяем любую активную встречу в системе');
                    apiUrl = 'http://localhost:3001/api/meetings/active';
                    
                    const response = await fetch(apiUrl);
                    const result = await response.json();
                    
                    if (response.ok && result.success && result.data) {
                        meeting = result.data;
                        console.log('Найдена активная встреча в системе:', meeting);
                        
                        // Если нужно сменить сотрудника на того, с кем идет встреча
                        if (changeEmployee && meeting.employee_id) {
                            await loadEmployeeById(meeting.employee_id);
                        }
                        
                        currentMeetingId = meeting.id;
                    } else {
                        console.log('Активных встреч в системе не найдено');
                        return;
                    }
                }
                
                // ЛОГИКА 4: Поиск активной встречи только с текущим сотрудником (было в checkForActiveMeeting)
                else if (type === 'currentEmployeeOnly') {
                    apiUrl = 'http://localhost:3001/api/meetings/active';
                    
                    const response = await fetch(apiUrl);
                    const result = await response.json();
                    
                    if (response.ok && result.success && result.data) {
                        const activeMeeting = result.data;
                        console.log('Обнаружена активная встреча в системе:', activeMeeting);
                        
                        // Инициализируем только если встреча с тем же сотрудником
                        if (currentEmployee && activeMeeting.employeeId === currentEmployee.id) {
                            meeting = activeMeeting;
                            currentMeetingId = activeMeeting.id;
                            console.log('Активная встреча с текущим сотрудником найдена');
                        } else {
                            console.log('Активная встреча найдена, но с другим сотрудником. Не инициализируем.');
                            return;
                        }
                    } else {
                        console.log('Активная встреча не найдена');
                        return;
                    }
                }
                
                // ОБЩАЯ ЛОГИКА ИНИЦИАЛИЗАЦИИ (объединенная из initializeActiveMeeting и дублированного кода)
                if (meeting && meeting.status === 'active' && meeting.started_at) {
                    console.log('Инициализируем активную встречу:', meeting);
                    
                    // Устанавливаем время начала встречи
                    startTime = new Date(meeting.started_at).getTime();
                    isRunning = true;
                    
                    // Запускаем автосохранение
                    startAutoSave();
                    
                    // Обновляем кнопку встречи (с дополнительными проверками из оригинала)
                    const startBtn = document.getElementById('start-meeting-btn');
                    if (startBtn) {
                        startBtn.textContent = 'Завершить встречу';
                        console.log('Первое обновление кнопки на "Завершить встречу"');
                    } else {
                        console.log('Кнопка start-meeting-btn не найдена при первом обновлении');
                    }
                    
                    // Запускаем таймер
                    timerInterval = setInterval(updateTimer, 1000);
                    updateTimer(); // Сразу обновляем
                    
                    // Обновляем состояние кнопки "Сменить сотрудника"
                    updateChangeEmployeeButton();
                    
                    // Обновляем состояние поля заметок
                    updateNotesFieldState();
                    
                    // Обновляем состояние области договоренностей
                    updateAgreementsFieldState();
                    
                    // Принудительно обновляем кнопку встречи (дополнительно из оригинального кода)
                    const meetingBtn = document.getElementById('start-meeting-btn');
                    if (meetingBtn) {
                        meetingBtn.textContent = 'Завершить встречу';
                        console.log('Кнопка принудительно обновлена на "Завершить встречу"');
                    }
                    
                    // Восстанавливаем контекст встречи (заметки и договоренности)
                    await restoreMeetingContext(meeting);
                    
                    // НОВАЯ ЛОГИКА: Всегда загружаем открытые договоренности из таблицы
                    await loadOpenAgreements(currentEmployee.id);
                    
                    console.log('Активная встреча инициализирована. isRunning:', isRunning, 'currentMeetingId:', currentMeetingId);
                }
                
            } catch (error) {
                console.error(`Ошибка проверки активной встречи (${type}):`, error);
            }
        }





        // Инициализация компонентов
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Страница conduct-meeting.html полностью загружена');
            
            // Проверяем наличие ключевых элементов DOM
            const avatarImg = document.getElementById('employee-avatar');
            const nameElement = document.getElementById('employee-name');
            const positionElement = document.getElementById('employee-position');
            const startBtn = document.getElementById('start-meeting-btn');
            
            console.log('DOM элементы найдены:', {
                avatar: !!avatarImg,
                name: !!nameElement, 
                position: !!positionElement,
                startBtn: !!startBtn
            });
            
            const sidebar = new O2OSidebar('meeting');
            sidebar.mount('sidebar-container');
            sidebar.startActiveMeetingCheck();
            
            // Инициализация обработчика видимости страницы для автосохранения
            setupVisibilityChangeHandler();
            
            // Инициализация иконок
            feather.replace();
            
            // Загружаем сотрудника (по URL параметрам или по умолчанию)
            try {
                await loadEmployee();
                console.log('Сотрудник загружен успешно');
            } catch (error) {
                console.error('Ошибка загрузки сотрудника:', error);
            }
            
            // Инициализируем состояние кнопки "Сменить сотрудника"
            updateChangeEmployeeButton();
            
            // Инициализируем состояние поля заметок
            updateNotesFieldState();
            
            // Инициализируем состояние области договоренностей
            updateAgreementsFieldState();
            
            // Интерактивность для слайдера оценки
            const satisfactionSlider = document.querySelector('input[type="range"]');
            const satisfactionValue = document.querySelector('.text-lg.font-bold.w-8.text-center');
            
            if (satisfactionSlider && satisfactionValue) {
                satisfactionSlider.addEventListener('input', function() {
                    satisfactionValue.textContent = this.value;
                    
                    // Изменение цвета в зависимости от значения
                    if (this.value <= 3) {
                        satisfactionValue.className = 'text-lg font-bold w-8 text-center text-error';
                    } else if (this.value <= 6) {
                        satisfactionValue.className = 'text-lg font-bold w-8 text-center text-warning';
                    } else {
                        satisfactionValue.className = 'text-lg font-bold w-8 text-center text-success';
                    }
                });
            }
            
            // Автосохранение заметок (дополнительное к основному автосохранению каждые 5 сек)
            const notesTextarea = document.getElementById('meeting-notes');
            if (notesTextarea) {
                let timeout;
                notesTextarea.addEventListener('input', function() {
                    hasUnsavedChanges = true; // Отмечаем что есть несохраненные изменения
                    clearTimeout(timeout);
                    // Дебаунс для быстрого сохранения при активной печати
                    timeout = setTimeout(() => {
                        if (isRunning && currentMeetingId) {
                            saveNotesToServer(this.value);
                        }
                    }, 3000); // 3 секунды после остановки печати
                });
            }
        });
    </script>
</body>
</html>

