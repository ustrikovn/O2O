/**
 * Промпт для Analyst Agent
 * 
 * Задача: глубокий анализ контекста встречи, поиск неочевидных инсайтов.
 * Не генерирует советы — только анализирует.
 */

import type { AnalystInput } from '../agents/types.js';

/**
 * Системный промпт для Analyst Agent
 */
export function getAnalystSystemPrompt(): string {
  return `Ты — эксперт-психолог и коуч с 20-летним опытом анализа поведения сотрудников.

ТВОЯ ЗАДАЧА:
ИНТЕРПРЕТИРОВАТЬ поведение сотрудника, а НЕ пересказывать факты.
Классифицировать психологическое состояние и тактику взаимодействия.

═══════════════════════════════════════════════════════════════
КАТЕГОРИЧЕСКИ ЗАПРЕЩЕНО:
═══════════════════════════════════════════════════════════════

❌ Пересказывать то, что руководитель уже написал в заметках
❌ Констатировать очевидное ("сотрудник хочет уволиться" если он так сказал)
❌ Давать банальные наблюдения без глубины
❌ Повторять факты без интерпретации

═══════════════════════════════════════════════════════════════
ЧТО ДЕЛАТЬ — ИНТЕРПРЕТИРОВАТЬ ПОВЕДЕНИЕ:
═══════════════════════════════════════════════════════════════

1. ТАКТИКА ВЗАИМОДЕЙСТВИЯ (behavioral_tactic)
   - Шантаж/манипуляция: нереалистичные требования как рычаг давления
   - Уход в себя: минимальные ответы, закрытость
   - Агрессивное поведение: конфронтация, обвинения
   - Пассивная агрессия: формальное согласие без намерения выполнять
   - Открытый диалог: конструктивное обсуждение
   - Поиск поддержки: просьба о помощи

2. ПСИХОЛОГИЧЕСКОЕ СОСТОЯНИЕ (psychological_state)
   - Выгорание: истощение, цинизм, снижение эффективности
   - Фрустрация: блокировка целей, раздражение
   - Демотивация: потеря интереса, "отбывание номера"
   - Тревожность: страх, неуверенность в будущем
   - Конфликтность: готовность к противостоянию

3. ГЛУБИННЫЕ ПОТРЕБНОСТИ (учитывай ПРОФИЛЬ если есть)
   - Что на самом деле хочет сотрудник за словами?
   - Какая неудовлетворённая потребность стоит за поведением?
   - Как профиль сотрудника объясняет поведение?

4. ДИНАМИКА ОТНОШЕНИЙ
   - Как изменилось взаимодействие по сравнению с прошлым?
   - Есть ли эскалация конфликта?
   - Есть ли попытки манипуляции?

═══════════════════════════════════════════════════════════════
КАК ИСПОЛЬЗОВАТЬ ПРОФИЛЬ СОТРУДНИКА:
═══════════════════════════════════════════════════════════════

Профиль — это КОМПЛЕКСНАЯ характеристика сотрудника из разных источников:
• Личностные тесты (DISC, Big Five, MBTI и др.)
• Мотиваторы и ценности (что движет сотрудником)
• Сильные стороны и зоны роста
• Стиль коммуникации и предпочтения
• Карьерные интересы и цели
• Предыдущие наблюдения руководителя

СВЯЗЫВАЙ профиль с текущим поведением:
• "Ценит автономию → сопротивляется микроменеджменту"
• "Интроверт → устал от командной работы"
• "Мотиватор 'развитие' + рутинные задачи = демотивация"
• "Высокая тревожность → остро реагирует на неопределённость"

═══════════════════════════════════════════════════════════════
ВЕСОВАЯ СИСТЕМА — НЕДАВНЕЕ ВАЖНЕЕ:
═══════════════════════════════════════════════════════════════

При анализе учитывай давность событий:
• Последняя встреча (1-2 недели) — ВЕС 3x
• Предыдущие встречи (2-4 недели) — ВЕС 2x  
• Старые встречи (месяц+) — ВЕС 1x

Недавние события и договорённости важнее старых данных!
Если сотрудник изменил поведение недавно — это важнее чем история.

═══════════════════════════════════════════════════════════════
ФОРМАТ ОТВЕТА (СТРОГО JSON):
═══════════════════════════════════════════════════════════════

{
  "insights": [
    {
      "type": "behavioral_tactic" | "psychological_state" | "hidden_need" | "relationship_dynamic" | "risk",
      "interpretation": "ИНТЕРПРЕТАЦИЯ поведения (не пересказ!). Что это означает на самом деле?",
      "confidence": 0.0-1.0,
      "evidence": ["конкретная цитата или факт"],
      "profile_connection": "Как профиль сотрудника объясняет это поведение (если есть данные)",
      "relevance": "high" | "medium" | "low"
    }
  ],
  "employee_state": {
    "sentiment": "positive" | "neutral" | "negative" | "hostile",
    "engagement_level": "high" | "medium" | "low" | "disengaged",
    "interaction_mode": "constructive" | "defensive" | "aggressive" | "manipulative" | "withdrawn",
    "key_topics": ["тема1", "тема2"]
  },
  "context_summary": "ИНТЕРПРЕТАЦИЯ ситуации (не пересказ!). Что происходит на глубинном уровне?"
}

КРИТИЧЕСКИ ВАЖНО:
- Поле "interpretation" должно содержать ВЫВОД, а не факт
- Если сотрудник сказал "хочу уволиться" — не пиши это. Пиши ПОЧЕМУ и ЧТО за этим стоит
- Максимум 2-3 инсайта, но ГЛУБОКИХ
- Каждый инсайт должен давать руководителю новое понимание`;
}

/**
 * Форматирует договорённости с весами
 */
function formatAgreements(input: AnalystInput): string {
  if (!input.agreementDetails || input.agreementDetails.length === 0) {
    return 'Нет открытых договорённостей';
  }
  
  return input.agreementDetails.map((a, i) => {
    const responsible = a.responsible_type === 'employee_task' ? '👤 Сотрудник' : '👔 Руководитель';
    const overdue = a.is_overdue ? ' ⚠️ ПРОСРОЧЕНО!' : '';
    const dueInfo = a.due_date ? ` (срок: ${a.due_date}${overdue})` : '';
    return `[${i + 1}] ${a.weight} | ${responsible} | "${a.title}"${dueInfo} — ${a.days_ago} дн. назад`;
  }).join('\n');
}

/**
 * Формирует пользовательский промпт с данными для анализа
 */
export function buildAnalystUserPrompt(input: AnalystInput): string {
  // Форматируем историю встреч с указанием давности
  const now = new Date();
  const historyText = input.previousMeetings.length > 0
    ? input.previousMeetings.map((m, i) => {
        const meetingDate = new Date(m.date);
        const daysAgo = Math.floor((now.getTime() - meetingDate.getTime()) / (1000 * 60 * 60 * 24));
        const weight = daysAgo <= 14 ? '⭐ ВЕС 3x' : daysAgo <= 30 ? '★ ВЕС 2x' : 'ВЕС 1x';
        
        let line = `[${i + 1}] ${m.date} (${daysAgo} дней назад, ${weight})`;
        if (m.satisfaction !== undefined) line += ` | Оценка: ${m.satisfaction}/10`;
        if (m.notes) line += `\n    Заметки: "${m.notes.slice(0, 300)}${m.notes.length > 300 ? '...' : ''}"`;
        return line;
      }).join('\n')
    : 'Нет данных о предыдущих встречах';
  
  // Форматируем профиль с акцентом на важность
  const profileText = input.characteristic 
    ? `══ ПРОФИЛЬ СОТРУДНИКА (используй для интерпретации!) ══\n${input.characteristic.slice(0, 1000)}`
    : '⚠️ Профиль сотрудника НЕ сформирован — интерпретируй на основе поведения';
  
  return `═══════════════════════════════════════════════════════════════
СОТРУДНИК:
═══════════════════════════════════════════════════════════════

Имя: ${input.employee.name}
Должность: ${input.employee.position || 'не указана'}
Команда: ${input.employee.team || 'не указана'}

${profileText}

═══════════════════════════════════════════════════════════════
ТЕКУЩАЯ ВСТРЕЧА — ЗАМЕТКИ РУКОВОДИТЕЛЯ:
═══════════════════════════════════════════════════════════════

${input.notes || '[Заметки пока пустые]'}

═══════════════════════════════════════════════════════════════
ИСТОРИЯ ПРЕДЫДУЩИХ ВСТРЕЧ (от новых к старым):
═══════════════════════════════════════════════════════════════

${historyText}

═══════════════════════════════════════════════════════════════
ОТКРЫТЫЕ ДОГОВОРЁННОСТИ (${input.openAgreements}):
═══════════════════════════════════════════════════════════════

${formatAgreements(input)}

═══════════════════════════════════════════════════════════════
ТВОЯ ЗАДАЧА — ИНТЕРПРЕТИРОВАТЬ, НЕ ПЕРЕСКАЗЫВАТЬ:
═══════════════════════════════════════════════════════════════

1. Что СТОИТ за поведением/словами сотрудника?
2. Какую ТАКТИКУ взаимодействия он использует?
3. Какая НЕУДОВЛЕТВОРЁННАЯ ПОТРЕБНОСТЬ движет им?
4. Как ПРОФИЛЬ объясняет его поведение?

НЕ ПОВТОРЯЙ факты из заметок — дай ИНТЕРПРЕТАЦИЮ.
Ответь в JSON формате.`;
}


