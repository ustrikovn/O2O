<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проведение One-to-One - O2O</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link rel="stylesheet" href="shared/styles/base.css">
    <style>
        /* Дополнительные стили для страницы встречи */
        .text-error { color: var(--error); }
        .text-warning { color: var(--warning); }
        .text-success { color: var(--success); }
        .text-info { color: var(--info); }
        .text-primary { color: var(--primary-blue); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }
        
        /* Дополнительные стили для метрик */
        .text-xs br { line-height: 1.1; }
        
        /* Donut Chart анимации */
        svg path {
            transition: stroke-dasharray 0.6s ease-in-out;
        }
        
        /* Hover эффекты для метрик */
        .metric-container:hover svg path:last-child {
            stroke-width: 3;
        }

        /* Custom checkbox styling */
        .custom-checkbox {
            appearance: none;
            width: 1rem;
            height: 1rem;
            border: 1px solid var(--primary-blue);
            border-radius: 0.25rem;
            background: var(--glass-bg);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .custom-checkbox:checked {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .custom-checkbox:hover {
            border-color: var(--primary-blue);
        }
        
        .bg-error { background-color: var(--error); }
        .bg-warning { background-color: var(--warning); }
        .bg-success { background-color: var(--success); }
        .bg-info { background-color: var(--info); }
        .bg-primary { background-color: var(--primary-blue); }
        
        /* Стили для тегов сотрудника */
        .employee-tag {
            display: inline-block;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .employee-tag:hover {
            transform: translateY(-1px);
        }
        
        /* Простая цветовая схема - только синий и серый */
        .team-tag {
            background: rgba(74, 144, 226, 0.15);
            border: 1px solid rgba(74, 144, 226, 0.3);
            color: var(--primary-blue);
        }
        
        .team-tag:hover {
            background: rgba(74, 144, 226, 0.25);
        }
        
        .experience-tag {
            background: rgba(107, 114, 128, 0.15);
            border: 1px solid rgba(107, 114, 128, 0.3);
            color: #6b7280;
        }
        
        .experience-tag:hover {
            background: rgba(107, 114, 128, 0.25);
        }
        
        .skill-tag {
            background: rgba(74, 144, 226, 0.15);
            border: 1px solid rgba(74, 144, 226, 0.3);
            color: var(--primary-blue);
        }
        
        .skill-tag:hover {
            background: rgba(74, 144, 226, 0.25);
        }
        
        .motivator-tag {
            background: rgba(107, 114, 128, 0.15);
            border: 1px solid rgba(107, 114, 128, 0.3);
            color: #6b7280;
        }
        
        .motivator-tag:hover {
            background: rgba(107, 114, 128, 0.25);
        }
        
        .activity-tag {
            background: rgba(74, 144, 226, 0.15);
            border: 1px solid rgba(74, 144, 226, 0.3);
            color: var(--primary-blue);
        }
        
        .activity-tag:hover {
            background: rgba(74, 144, 226, 0.25);
        }
        
        /* Фиксированная ширина для кнопки встречи */
        #start-meeting-btn {
            width: 170px;
            white-space: nowrap;
            height: 38px;
        }
        
        /* Фиксированная высота для кнопки смены сотрудника */
        button[onclick="changeEmployee()"] {
            height: 38px;
        }
        
        /* Стилизация range slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Адаптивность для мобильных устройств */
        @media (max-width: 1024px) {
            .lg\\:col-span-2 {
                grid-column: span 1;
            }
            
            .lg\\:grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .lg\\:grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .flex-1.ml-64 {
                margin-left: 0;
                padding: 1rem;
            }
            
            #metrics-block .flex.items-start.space-x-8 {
                flex-wrap: wrap;
                gap: 1rem;
                justify-content: center;
            }
        }
        
        @media (max-width: 768px) {
            .grid.grid-cols-1.lg\\:grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            #employee-info-block .flex.items-start.space-x-4 {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
                text-align: center;
            }
            
            /* Адаптивность для блока тегов */
            .glass-card .flex.items-center.justify-between {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .glass-card .flex.items-center.justify-between > div:first-child {
                align-self: center;
            }
            
            .glass-card .flex.items-center.justify-between > div:last-child {
                align-self: center;
                justify-content: center;
            }
            
            #metrics-block .flex.items-start.space-x-8 {
                flex-direction: column;
                gap: 1.5rem;
                padding-top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="flex min-h-screen">
        <!-- Sidebar Container -->
        <div id="sidebar-container"></div>
        
        <!-- Main Content -->
        <div class="flex-1 ml-64 p-8">
            <!-- Кнопка начала встречи и секундомер -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <button class="glass-button glass-button-primary px-3 py-2 text-sm flex items-center justify-center" onclick="changeEmployee()" title="Сменить сотрудника">
                        <i data-feather="refresh-cw" class="w-3.5 h-3.5"></i>
                    </button>
                    
                    <button id="start-meeting-btn" class="glass-button glass-button-primary px-4 py-2 text-sm flex items-center justify-center" onclick="startMeeting()">
                        Начать встречу
                    </button>
                    
                    <!-- Секундомер -->
                    <div id="timer-display" class="text-sm text-gray-500 font-mono">
                        <span id="timer-text">00:00:00</span>
                    </div>
                </div>
            </div>
            
            <!-- Профиль сотрудника -->
            <div class="glass-card p-4 mb-6">
                <div class="flex items-center justify-between">
                    <!-- Левая часть: Аватар и информация -->
                    <div class="flex items-center">
                        <!-- Аватар -->
                        <img id="employee-avatar" src="" alt="Загрузка..." class="w-12 h-12 rounded-full">
                        
                    <!-- Информация о сотруднике -->
                    <div class="ml-4">
                        <h3 id="employee-name" class="font-semibold">Загрузка...</h3>
                        <p id="employee-position" class="text-sm text-gray-600">Загрузка...</p>
                    </div>
                </div>
                
                <!-- Метрики сотрудника -->
                <div class="flex items-center space-x-12">
                    <!-- Важность сотрудника -->
                    <div class="flex items-center space-x-3">
                        <div class="relative w-9 h-9 flex-shrink-0">
                            <svg class="w-9 h-9 transform -rotate-90" viewBox="0 0 36 36">
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                                      fill="none" stroke="#e5e7eb" stroke-width="2"/>
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                                      fill="none" stroke="var(--accent-purple)" stroke-width="2" 
                                      stroke-dasharray="78, 100" stroke-linecap="round"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-sm font-semibold text-primary">7.8</span>
                            </div>
                        </div>
                        <div class="text-sm text-secondary">
                            <div>Важность</div>
                        </div>
                    </div>
                    
                    <!-- Счастье сотрудника -->
                    <div class="flex items-center space-x-3">
                        <div class="relative w-9 h-9 flex-shrink-0">
                            <svg class="w-9 h-9 transform -rotate-90" viewBox="0 0 36 36">
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                                      fill="none" stroke="#e5e7eb" stroke-width="2"/>
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                                      fill="none" stroke="var(--primary-blue)" stroke-width="2" 
                                      stroke-dasharray="85, 100" stroke-linecap="round"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-sm font-semibold text-primary">8.5</span>
                            </div>
                        </div>
                        <div class="text-sm text-secondary">
                            <div>Счастье</div>
                        </div>
                    </div>
                </div>
                
                <!-- Теги сотрудника -->
                <div class="px-2 flex flex-col justify-center">
                    <div class="flex flex-wrap gap-2 mb-2">
                        <span class="employee-tag team-tag">Команда контента</span>
                        <span class="employee-tag experience-tag">3 года в команде</span>
                        <span class="employee-tag skill-tag">Бизнес-анализ</span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <span class="employee-tag motivator-tag">Деньги</span>
                        <span class="employee-tag activity-tag">Исполнительность</span>
                    </div>
                </div>
                </div>
            </div>

            <!-- Main Content Grid: AI Assistant (1/3) + Notes/Agreements (2/3) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- AI Assistant Chat - Left 1/3 -->
                <div class="glass-card p-6 flex flex-col h-[520px]" id="ai-chat-block">
                    <h2 class="text-xl font-semibold mb-4">AI-ассистент</h2>
                    
                    <!-- Chat Messages -->
                    <div class="flex-1 overflow-y-auto mb-4 space-y-3" id="chat-messages">
                        <!-- AI Message -->
                        <div class="text-sm max-w-xs">
                            Привет! Я готов помочь вам провести эффективную встречу с Анной. Вот несколько рекомендаций:
                        </div>
                        
                        <!-- Suggestion Buttons -->
                        <div class="space-y-2">
                            <button class="bg-primary text-white py-2 text-left text-xs inline-block hover:bg-primary/90 hover:shadow-lg transition-all duration-200" style="border-radius: 0px 25px 25px 25px; padding-left: 10px; padding-right: 15px;" onclick="sendSuggestion('Какие задачи вызывают у вас трудности?')">
                                Какие задачи вызывают у вас трудности?
                            </button>
                            <button class="bg-primary text-white py-2 text-left text-xs inline-block hover:bg-primary/90 hover:shadow-lg transition-all duration-200" style="border-radius: 0px 25px 25px 25px; padding-left: 10px; padding-right: 15px;" onclick="sendSuggestion('Расскажите о ваших карьерных планах')">
                                Расскажите о ваших карьерных планах
                            </button>
                            <button class="bg-primary text-white py-2 text-left text-xs inline-block hover:bg-primary/90 hover:shadow-lg transition-all duration-200" style="border-radius: 0px 25px 25px 25px; padding-left: 10px; padding-right: 15px;" onclick="sendSuggestion('Сгенерировать отчет о встрече')">
                                Сгенерировать отчет о встрече
                            </button>
                        </div>
                        
                        <!-- AI Message 2 -->
                        <div class="text-sm max-w-xs">
                            Анализ показывает рост удовлетворенности сотрудника на 12% за последние 3 месяца. Рекомендую обсудить факторы успеха.
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="chat-input"
                            class="glass-input glass-input-primary flex-1 text-sm" 
                            placeholder="Напишите сообщение..."
                            onkeypress="handleChatKeypress(event)">
                        <button 
                            class="glass-button glass-button-primary px-3 py-2"
                            onclick="sendMessage()">
                            <svg class="w-4 h-4 rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Notes and Agreements Block - Right 2/3 -->
                <div class="lg:col-span-2 glass-card p-6 flex flex-col" id="notes-agreements-block">
                    <!-- Notes Section -->
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold mb-4">Заметки</h2>
                        <textarea 
                            class="glass-input w-full h-60 resize-none" 
                            placeholder="Записывайте ключевые моменты встречи, обратную связь от сотрудника и ваши наблюдения..."></textarea>
                    </div>
                    
                    <!-- Agreements Section -->
                    <div class="flex-1 flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold">Договоренности</h2>
                            <button class="glass-button px-3 py-1 text-sm" onclick="addNewAgreement()">
                                + Добавить пункт
                            </button>
                        </div>
                        
                        <!-- Agreements List -->
                        <div id="agreements-list" class="mb-4">
                            <!-- Договоренности будут загружены автоматически -->
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="shared/ui/sidebar.js"></script>
    <script src="shared/ui/modal.js"></script>
    <script src="shared/ui/employee-selector-modal.js"></script>
    
    <script>
        // Agreements functionality
        async function addNewAgreement() {
            // Сохраняем все редактируемые пункты перед добавлением нового
            await saveAllEditingAgreements();
            
            const agreementsList = document.getElementById('agreements-list');
            const newAgreement = document.createElement('div');
            newAgreement.className = 'flex items-center space-x-3 p-2 bg-glass rounded editing';
            
            // Получаем завтрашнюю дату по умолчанию
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const defaultDate = tomorrow.toISOString().split('T')[0];
            
            newAgreement.innerHTML = `
                <input type="checkbox" class="custom-checkbox">
                <input type="text" class="text-sm font-medium flex-1 bg-transparent border-none outline-none" 
                       placeholder="Введите задачу..." onblur="saveTaskText(this)" onkeypress="handleTaskKeypress(event, this)">
                <input type="date" class="text-xs text-muted bg-transparent border-none outline-none" 
                       value="${defaultDate}" onchange="saveDateChange(this)">
                <select class="text-xs bg-primary/20 text-primary px-2 py-0.5 rounded border-none outline-none" 
                        onchange="saveResponsibleChange(this)">
                    <option value="employee" class="bg-white text-black">Сотрудник</option>
                    <option value="manager" class="bg-white text-black">Руководитель</option>
                </select>
                <button onclick="removeAgreement(this)" class="text-xs text-red-500 hover:text-red-700 ml-2">✕</button>
            `;
            
            agreementsList.appendChild(newAgreement);
            
            // Фокус на поле задачи
            const taskInput = newAgreement.querySelector('input[type="text"]');
            taskInput.focus();
        }
        
        function handleTaskKeypress(event, input) {
            if (event.key === 'Enter') {
                input.blur();
            }
        }
        
        async function saveTaskText(input) {
            if (input.value.trim() === '') {
                // Если задача пустая, удаляем пункт
                input.closest('.flex').remove();
            } else {
                // Сохраняем пункт - убираем режим редактирования
                await saveAgreementItem(input.closest('.flex'));
            }
        }
        
        async function saveAgreementItem(agreementElement) {
            const taskInput = agreementElement.querySelector('input[type="text"]');
            const dateInput = agreementElement.querySelector('input[type="date"]');
            const responsibleSelect = agreementElement.querySelector('select');
            const removeButton = agreementElement.querySelector('button');
            
            if (taskInput.value.trim() === '') {
                return; // Не сохраняем пустые задачи
            }
            
            const task = taskInput.value;
            const responsible = responsibleSelect.value;
            const agreementType = responsible === 'employee' ? 'employee_task' : 'manager_task';
            const dueDate = dateInput.value;
            
            // Сохраняем на сервер, если есть активная встреча
            if (currentMeetingId) {
                const saved = await addAgreementToServer(task, agreementType, dueDate);
                if (!saved) {
                    alert('Ошибка сохранения договоренности на сервер');
                    return;
                }
            }
            
            // Убираем класс редактирования
            agreementElement.classList.remove('editing');
            
            // Конвертируем в обычный вид
            const date = new Date(dateInput.value).toLocaleDateString('ru-RU');
            const responsibleText = responsible === 'employee' ? 'Сотрудник' : 'Руководитель';
            const responsibleClass = responsible === 'employee' ? 'bg-primary/20 text-primary' : 'bg-accent-green/20 text-accent-green';
            
            agreementElement.innerHTML = `
                <input type="checkbox" class="custom-checkbox">
                <span class="text-sm font-medium flex-1">${task}</span>
                <span class="text-xs text-muted">${date}</span>
                <span class="text-xs ${responsibleClass} px-2 py-0.5 rounded">${responsibleText}</span>
            `;
        }
        
        async function saveAllEditingAgreements() {
            const editingAgreements = document.querySelectorAll('.editing');
            for (const agreement of editingAgreements) {
                const taskInput = agreement.querySelector('input[type="text"]');
                if (taskInput && taskInput.value.trim() !== '') {
                    await saveAgreementItem(agreement);
                } else if (taskInput && taskInput.value.trim() === '') {
                    agreement.remove();
                }
            }
        }
        
        function saveDateChange(input) {
            // Дата автоматически сохраняется при изменении
        }
        
        function saveResponsibleChange(select) {
            const isEmployee = select.value === 'employee';
            select.className = `text-xs px-2 py-0.5 rounded border-none outline-none ${
                isEmployee ? 'bg-primary/20 text-primary' : 'bg-accent-green/20 text-accent-green'
            }`;
        }
        
        function removeAgreement(button) {
            button.closest('.flex').remove();
        }
        
        // Автосохранение при клике вне области редактирования
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.addEventListener('click', async function(event) {
                    // Игнорируем клики по кнопкам и элементам управления
                    if (event.target.closest('button') || 
                        event.target.closest('input') || 
                        event.target.closest('select') ||
                        event.target.closest('.editing')) {
                        return;
                    }
                    
                    // Сохраняем все редактируемые пункты
                    await saveAllEditingAgreements();
                });
            }, 100);
        });
        
        // Chat functionality
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message === '') return;
            
            // Добавляем сообщение пользователя
            addUserMessage(message);
            
            // Очищаем поле ввода
            input.value = '';
            
            // Симулируем ответ AI через короткую задержку
            setTimeout(() => {
                const aiResponse = generateAIResponse(message);
                addAIMessage(aiResponse);
            }, 1000);
        }
        
        function sendSuggestion(suggestion) {
            addUserMessage(suggestion);
            
            // Симулируем ответ AI
            setTimeout(() => {
                let response = '';
                if (suggestion.includes('трудности')) {
                    response = 'Отличный вопрос! Это поможет выявить препятствия в работе. Рекомендую также спросить: "Какая поддержка от команды или руководства поможет вам справиться с этими трудностями?"';
                } else if (suggestion.includes('карьерные планы')) {
                    response = 'Важная тема для развития! После этого можно обсудить: "Какие навыки вы хотели бы развить в ближайшие 6 месяцев?" и "Как я могу помочь вам в достижении ваших целей?"';
                } else if (suggestion.includes('отчет')) {
                    response = 'Готовлю отчет о встрече на основе введенных заметок и договоренностей. Отчет будет содержать основные темы, выводы и план действий.';
                } else {
                    response = 'Понял ваш запрос. Могу предложить дополнительные вопросы или рекомендации для эффективного проведения встречи.';
                }
                addAIMessage(response);
            }, 1000);
        }
        
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function addUserMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end';
            
            messageDiv.innerHTML = `
                <div class="text-primary text-sm max-w-xs text-right">
                    ${message}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function addAIMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'text-sm max-w-xs';
            messageDiv.textContent = message;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function generateAIResponse(userMessage) {
            const responses = [
                'Интересная мысль! Это может быть полезно для развития команды.',
                'Рекомендую зафиксировать это в договоренностях для дальнейшего отслеживания.',
                'Хороший подход! Можно также рассмотреть альтернативные варианты.',
                'Это поможет улучшить взаимодействие в команде. Стоит обсудить детали.',
                'Отличная идея для повышения эффективности работы!'
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Функциональность секундомера
        let timerInterval = null;
        let startTime = null;
        let isRunning = false;
        
        async function startMeeting() {
            const btn = document.getElementById('start-meeting-btn');
            const timerText = document.getElementById('timer-text');
            
            if (!isRunning) {
                // Проверяем, что выбран сотрудник
                if (!currentEmployee) {
                    alert('Пожалуйста, выберите сотрудника для встречи');
                    return;
                }
                
                try {
                    // Блокируем кнопку во время запроса
                    btn.disabled = true;
                    btn.textContent = 'Создание встречи...';
                    
                    // Создаем встречу через API
                    const response = await fetch('http://localhost:3001/api/meetings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            employeeId: currentEmployee.id
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.message || 'Ошибка создания встречи');
                    }
                    
                    if (result.success) {
                        // Сохраняем ID созданной встречи
                        currentMeetingId = result.data.id;
                        console.log('Встреча создана с ID:', currentMeetingId);
                        
                        // Начинаем встречу через API
                        const startResponse = await fetch(`http://localhost:3001/api/meetings/${currentMeetingId}/start`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const startResult = await startResponse.json();
                        
                        if (!startResponse.ok) {
                            throw new Error(startResult.message || 'Ошибка начала встречи');
                        }
                        
                        if (startResult.success) {
                            // Запускаем секундомер
                            startTime = Date.now();
                            isRunning = true;
                            
                            // Меняем текст кнопки
                            btn.textContent = 'Завершить встречу';
                            btn.disabled = false;
                            
                            // Перерисовываем иконки Feather
                            feather.replace();
                            
                            // Запускаем интервал обновления
                            timerInterval = setInterval(updateTimer, 1000);
                            updateTimer(); // Сразу обновляем
                            
                            console.log('Встреча успешно начата');
                        }
                    }
                    
                } catch (error) {
                    console.error('Ошибка при создании/начале встречи:', error);
                    alert(`Ошибка: ${error.message}`);
                    
                    // Возвращаем кнопку в исходное состояние
                    btn.textContent = 'Начать встречу';
                    btn.disabled = false;
                }
                
            } else {
                // Завершаем встречу
                try {
                    // Блокируем кнопку во время запроса
                    btn.disabled = true;
                    btn.textContent = 'Завершение встречи...';
                    
                    if (currentMeetingId) {
                        // Завершаем встречу через API
                        const response = await fetch(`http://localhost:3001/api/meetings/${currentMeetingId}/end`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                notes: document.querySelector('#notes-agreements-block textarea')?.value || ''
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.message || 'Ошибка завершения встречи');
                        }
                        
                        if (result.success) {
                            console.log('Встреча успешно завершена');
                        }
                    }
                    
                    // Останавливаем секундомер
                    isRunning = false;
                    clearInterval(timerInterval);
                    
                    // Возвращаем исходный текст кнопки
                    btn.textContent = 'Начать встречу';
                    btn.disabled = false;
                    
                    // Перерисовываем иконки Feather
                    feather.replace();
                    
                    // Сбрасываем таймер
                    timerText.textContent = '00:00:00';
                    
                    // Сбрасываем ID встречи
                    currentMeetingId = null;
                    
                } catch (error) {
                    console.error('Ошибка при завершении встречи:', error);
                    alert(`Ошибка завершения встречи: ${error.message}`);
                    
                    // В случае ошибки всё равно останавливаем локальный таймер
                    isRunning = false;
                    clearInterval(timerInterval);
                    btn.textContent = 'Начать встречу';
                    btn.disabled = false;
                    timerText.textContent = '00:00:00';
                }
            }
        }
        
        function updateTimer() {
            if (!isRunning || !startTime) return;
            
            const elapsed = Date.now() - startTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            const formatNumber = (num) => num.toString().padStart(2, '0');
            
            const timerText = document.getElementById('timer-text');
            timerText.textContent = `${formatNumber(hours)}:${formatNumber(minutes % 60)}:${formatNumber(seconds % 60)}`;
        }
        
        // Переменная для хранения данных текущего сотрудника
        let currentEmployee = null;
        
        // Переменная для хранения ID текущей встречи
        let currentMeetingId = null;

        // Глобальная переменная для модального окна выбора сотрудника
        let employeeSelectorModal = null;

        // Функция загрузки сотрудника при инициализации
        async function loadEmployee() {
            // Проверяем URL параметры
            const urlParams = new URLSearchParams(window.location.search);
            const employeeId = urlParams.get('employeeId');
            const meetingId = urlParams.get('meetingId');
            
            if (employeeId) {
                console.log('Загружаем сотрудника по ID из URL:', employeeId);
                await loadEmployeeById(employeeId);
                if (meetingId) {
                    currentMeetingId = meetingId;
                    console.log('ID встречи из URL:', meetingId);
                }
            } else {
                // Загружаем первого сотрудника по умолчанию
                await loadDefaultEmployee();
            }
        }

        // Функция загрузки конкретного сотрудника по ID
        async function loadEmployeeById(employeeId) {
            try {
                const response = await fetch(`http://localhost:3001/api/employees/${employeeId}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    currentEmployee = result.data;
                    updateCurrentEmployee(currentEmployee);
                    console.log('Сотрудник загружен по ID:', currentEmployee);
                } else {
                    console.error('Сотрудник не найден:', employeeId);
                    // Загружаем первого сотрудника по умолчанию
                    await loadDefaultEmployee();
                }
            } catch (error) {
                console.error('Ошибка загрузки сотрудника по ID:', error);
                // Загружаем первого сотрудника по умолчанию
                await loadDefaultEmployee();
            }
        }

        // Функция загрузки первого сотрудника при инициализации
        async function loadDefaultEmployee() {
            try {
                const response = await fetch('http://localhost:3001/api/employees');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    currentEmployee = result.data[0]; // Берем первого сотрудника
                    updateCurrentEmployee(currentEmployee);
                } else {
                    // Если нет сотрудников, показываем заглушку для договоренностей
                    showAgreementsPlaceholder();
                }
            } catch (error) {
                console.error('Ошибка загрузки сотрудника по умолчанию:', error);
                showAgreementsPlaceholder();
            }
        }

        // Функция смены сотрудника
        function changeEmployee() {
            // Создаем и открываем модальное окно для выбора сотрудника
            employeeSelectorModal = new EmployeeSelectorModal({
                title: 'Выберите сотрудника для встречи',
                currentEmployeeId: currentEmployee ? currentEmployee.id : null,
                onEmployeeSelect: (selectedEmployee) => {
                    updateCurrentEmployee(selectedEmployee);
                },
                onClose: () => {
                    employeeSelectorModal = null;
                    window.currentEmployeeSelectorModal = null;
                }
            });
            
            // Устанавливаем глобальную ссылку для доступа из HTML
            window.currentEmployeeSelectorModal = employeeSelectorModal;
            
            employeeSelectorModal.open();
        }

        // Функция обновления отображения текущего сотрудника
        function updateCurrentEmployee(employee) {
            currentEmployee = employee;
            
            // Обновляем аватар
            const avatarImg = document.getElementById('employee-avatar');
            if (avatarImg) {
                if (employee.photoUrl) {
                    avatarImg.src = employee.photoUrl;
                } else {
                    // Создаем аватар с инициалами
                    const initials = `${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}`;
                    const color = generateAvatarColor(employee.first_name + employee.last_name);
                    avatarImg.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50'%3E%3Ccircle cx='25' cy='25' r='25' fill='%23${color}'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='white' font-family='Arial' font-size='12'%3E${initials}%3C/text%3E%3C/svg%3E`;
                }
                avatarImg.alt = `${employee.first_name} ${employee.last_name}`;
            }
            
            // Обновляем имя и должность
            const nameElement = document.getElementById('employee-name');
            if (nameElement) {
                nameElement.textContent = `${employee.first_name} ${employee.last_name}`;
            }
            
            const positionElement = document.getElementById('employee-position');
            if (positionElement) {
                positionElement.textContent = employee.position;
            }
            
            // Очищаем текущие заметки и договоренности
            clearNotesAndAgreements();
            
            // Загружаем договоренности с последней встречи
            loadLastMeetingAgreements(employee.id);
            
            console.log('Сотрудник изменен на:', employee);
        }

        // Функция генерации цвета аватара на основе имени
        function generateAvatarColor(name) {
            const colors = [
                '4A90E2', '50E3C2', '9013FE', 'F5A623',
                'D0021B', '7ED321', 'BD10E0', 'B8E986',
                '9B9B9B', 'F8E71C', '8B572A', '417505'
            ];
            
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const selectedColor = colors[Math.abs(hash) % colors.length];
            console.log(`Цвет для "${name}": ${selectedColor} (хеш: ${hash})`);
            
            return selectedColor;
        }

        /**
         * Глобальная функция для обработки клика на "Встреча" в сайдбаре
         * На странице встречи ничего не делаем
         */
        function startMeetingFromSidebar(event) {
            event.preventDefault();
            // На странице встречи ничего не делаем - остаемся где были
            console.log('Уже на странице встречи');
        }

        /**
         * Функция для сохранения заметок на сервер
         */
        async function saveNotesToServer(notes) {
            if (!currentMeetingId || !notes.trim()) {
                return; // Не сохраняем пустые заметки или если нет активной встречи
            }
            
            try {
                const response = await fetch(`http://localhost:3001/api/meetings/${currentMeetingId}/notes`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notes: notes
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    console.log('Заметки автоматически сохранены');
                } else {
                    console.error('Ошибка сохранения заметок:', result.message);
                }
            } catch (error) {
                console.error('Ошибка при сохранении заметок:', error);
            }
        }

        /**
         * Функция для добавления договоренности на сервер
         */
        async function addAgreementToServer(title, type, dueDate) {
            if (!currentMeetingId || !title.trim()) {
                return false;
            }
            
            try {
                const response = await fetch(`http://localhost:3001/api/meetings/${currentMeetingId}/agreements`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        type: type, // 'employee_task' или 'manager_task'
                        description: '',
                        dueDate: dueDate
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    console.log('Договоренность добавлена на сервер');
                    return true;
                } else {
                    console.error('Ошибка добавления договоренности:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('Ошибка при добавлении договоренности:', error);
                return false;
            }
        }

        /**
         * Функция очистки заметок и договоренностей
         */
        function clearNotesAndAgreements() {
            // Очищаем поле заметок
            const notesTextarea = document.querySelector('#notes-agreements-block textarea');
            if (notesTextarea) {
                notesTextarea.value = '';
            }
            
            // Очищаем список договоренностей (удаляем все существующие)
            const agreementsList = document.getElementById('agreements-list');
            if (agreementsList) {
                agreementsList.innerHTML = '';
            }
        }

        /**
         * Функция загрузки договоренностей с последней встречи
         */
        async function loadLastMeetingAgreements(employeeId) {
            if (!employeeId) {
                console.log('Не указан ID сотрудника для загрузки договоренностей');
                showAgreementsPlaceholder();
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:3001/api/meetings/employees/${employeeId}/last-agreements`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const { agreements } = result.data;
                    
                    if (agreements && agreements.length > 0) {
                        console.log('Загружены договоренности с последней встречи:', agreements);
                        renderAgreements(agreements);
                    } else {
                        console.log('Нет договоренностей с последней встречи');
                        showAgreementsPlaceholder();
                    }
                } else {
                    console.error('Ошибка загрузки договоренностей:', result.message);
                    showAgreementsPlaceholder();
                }
            } catch (error) {
                console.error('Ошибка при загрузке договоренностей:', error);
                showAgreementsPlaceholder();
            }
        }

        /**
         * Функция отображения заглушки для договоренностей
         */
        function showAgreementsPlaceholder() {
            const agreementsList = document.getElementById('agreements-list');
            if (agreementsList) {
                agreementsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="mb-2">
                            <svg class="w-12 h-12 mx-auto opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <p class="text-sm">Нет открытых договоренностей с последней встречи</p>
                        <p class="text-xs text-gray-400 mt-1">Добавьте новые договоренности в ходе встречи</p>
                    </div>
                `;
            }
        }

        /**
         * Функция отображения договоренностей из последней встречи
         */
        function renderAgreements(agreements) {
            const agreementsList = document.getElementById('agreements-list');
            if (!agreementsList) return;
            
            // Очищаем список
            agreementsList.innerHTML = '';
            
            agreements.forEach(agreement => {
                const agreementElement = document.createElement('div');
                agreementElement.className = 'flex items-center space-x-3 p-2 bg-glass rounded';
                
                // Определяем тип ответственного
                const isEmployee = agreement.type === 'employee_task';
                const responsibleText = isEmployee ? 'Сотрудник' : 'Руководитель';
                const responsibleClass = isEmployee ? 'bg-primary/20 text-primary' : 'bg-accent-green/20 text-accent-green';
                
                // Форматируем дату (если есть)
                let dateText = '';
                if (agreement.created_at) {
                    const date = new Date(agreement.created_at);
                    dateText = date.toLocaleDateString('ru-RU');
                }
                
                agreementElement.innerHTML = `
                    <input type="checkbox" class="custom-checkbox">
                    <span class="text-sm font-medium flex-1">${agreement.title}</span>
                    ${dateText ? `<span class="text-xs text-muted">${dateText}</span>` : ''}
                    <span class="text-xs ${responsibleClass} px-2 py-0.5 rounded">${responsibleText}</span>
                `;
                
                agreementsList.appendChild(agreementElement);
            });
        }
    </script>
    <script>
        // Инициализация компонентов
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = new O2OSidebar('meeting');
            sidebar.mount('sidebar-container');
            sidebar.startActiveMeetingCheck();
            
            // Инициализация иконок
            feather.replace();
            
            // Загружаем сотрудника (по URL параметрам или по умолчанию)
            loadEmployee();
            
            // Интерактивность для слайдера оценки
            const satisfactionSlider = document.querySelector('input[type="range"]');
            const satisfactionValue = document.querySelector('.text-lg.font-bold.w-8.text-center');
            
            if (satisfactionSlider && satisfactionValue) {
                satisfactionSlider.addEventListener('input', function() {
                    satisfactionValue.textContent = this.value;
                    
                    // Изменение цвета в зависимости от значения
                    if (this.value <= 3) {
                        satisfactionValue.className = 'text-lg font-bold w-8 text-center text-error';
                    } else if (this.value <= 6) {
                        satisfactionValue.className = 'text-lg font-bold w-8 text-center text-warning';
                    } else {
                        satisfactionValue.className = 'text-lg font-bold w-8 text-center text-success';
                    }
                });
            }
            
            // Автосохранение заметок
            const notesTextarea = document.querySelector('#notes-agreements-block textarea');
            if (notesTextarea) {
                let timeout;
                notesTextarea.addEventListener('input', function() {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        saveNotesToServer(this.value);
                    }, 2000);
                });
            }
        });
    </script>
</body>
</html>
