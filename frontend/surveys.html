<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Опросы - O2O</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link rel="stylesheet" href="shared/styles/base.css">
    <style>
        /* Стили для карточек вариантов ответа */
        .option-card {
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }
        
        .option-label {
            display: block;
            cursor: pointer;
            padding: 18px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .option-label:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .option-radio {
            display: none;
        }
        
        .option-content {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .option-check {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        
        .option-check::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 12px;
            height: 12px;
            background: #3b82f6;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .option-text {
            font-size: 15px;
            line-height: 1.5;
            color: #374151;
            font-weight: 500;
        }
        
        /* Стили для выбранной карточки */
        .option-card.selected .option-label {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .option-card.selected .option-check {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .option-card.selected .option-check::after {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .option-card.selected .option-text {
            color: #1e40af;
        }
        
        /* Анимация для иконки раскрытия подсказок */
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        /* Пульсирующая анимация для привлечения внимания к подсказке */
        @keyframes hint-pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.02);
            }
        }
        
        .hint-animate {
            animation: hint-pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="flex min-h-screen">
        <!-- Sidebar Container -->
        <div id="sidebar-container"></div>
        
        <!-- Main Content -->
        <div class="flex-1 ml-64 p-8">
            <div class="max-w-6xl mx-auto">
                <!-- Выбор опроса и сотрудника -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <!-- Выбор сотрудника -->
                    <div class="glass-card p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-feather="user" class="mr-2 w-5 h-5"></i>
                            Выбор сотрудника
                        </h2>
                        <div class="space-y-3">
                            <div id="employee-dropdown-container"></div>
                            <div id="employee-info" class="text-sm text-gray-600 p-3 bg-gray-50 rounded-lg hidden">
                                <div class="flex items-center space-x-3">
                                    <img id="employee-avatar" src="" alt="" class="w-10 h-10 rounded-full bg-gray-200">
                                    <div>
                                        <p id="employee-name" class="font-medium"></p>
                                        <p id="employee-position" class="text-gray-500"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Выбор опроса -->
                    <div class="glass-card p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i data-feather="clipboard" class="mr-2 w-5 h-5"></i>
                            Выбор опроса
                        </h2>
                        <div class="space-y-3">
                            <div id="survey-dropdown-container"></div>
                            <!-- Hidden input для совместимости с существующим кодом -->
                            <input type="hidden" id="survey-select" value="">
                            <div id="survey-description" class="text-sm text-gray-600 p-3 bg-gray-50 rounded-lg hidden">
                                <p>Описание опроса появится здесь после выбора</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Статус прохождения опроса -->
                <div class="glass-card p-4 mb-6" id="survey-status-card" style="display: none;">
                    <div id="survey-status-content">
                        <!-- Контент будет добавляться динамически -->
                    </div>
                    
                    <!-- Действия интегрированы в статусный блок -->
                    <div class="mt-4 pt-4 border-t border-gray-200" id="survey-actions">
                        <div class="flex flex-wrap gap-3">
                            <button id="start-survey-btn" class="glass-button px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                                <i data-feather="play" class="mr-2 w-4 h-4 inline"></i>
                                Начать опрос
                            </button>
                            <button id="view-results-btn" class="glass-button px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:shadow-lg text-sm" style="display: none;">
                                <i data-feather="eye" class="mr-2 w-4 h-4 inline"></i>
                                Просмотреть результаты
                            </button>
                            <button id="retake-survey-btn" class="glass-button px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:shadow-lg text-sm" style="display: none;">
                                <i data-feather="refresh-cw" class="mr-2 w-4 h-4 inline"></i>
                                Пройти заново
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Интерфейс прохождения опроса -->
            <div class="glass-card p-6 hidden" id="survey-taking-interface">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i data-feather="help-circle" class="mr-2"></i>
                        <span id="survey-taking-title">Прохождение опроса</span>
                    </h2>
                    <button onclick="cancelSurvey()" class="glass-button px-4 py-2 rounded-lg flex items-center">
                        <i data-feather="x" class="mr-2"></i>
                        Отменить
                    </button>
                </div>
                
                <!-- Прогресс бар -->
                <div class="mb-6">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Прогресс прохождения</span>
                        <span id="progress-text">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Блок секции -->
                <div id="section-indicator" class="mb-6 pl-4 border-l-4 border-blue-500 hidden">
                    <h4 id="section-title" class="text-base font-semibold text-gray-900 mb-1">Название секции</h4>
                    <p id="section-description" class="text-sm text-gray-600">Описание секции</p>
                </div>
                
                <!-- Вопрос -->
                <div id="question-container">
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-800 mb-4" id="question-title">Загрузка вопроса...</h3>
                        <div id="question-options" class="space-y-3">
                            <!-- Опции будут добавлены динамически -->
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-6">
                        <button onclick="previousQuestion()" id="prev-btn" class="glass-button px-4 py-2 rounded-lg flex items-center disabled:opacity-50" disabled>
                            <i data-feather="chevron-left" class="mr-2"></i>
                            Назад
                        </button>
                        <button onclick="nextQuestion()" id="next-btn" class="glass-button px-4 py-2 rounded-lg flex items-center disabled:opacity-50" disabled>
                            Далее
                            <i data-feather="chevron-right" class="ml-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Результат опроса -->
                <div id="survey-completion" class="hidden text-center">
                    <div class="mb-6">
                        <i data-feather="check-circle" class="mx-auto text-green-500 mb-4" style="width: 64px; height: 64px;"></i>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Опрос завершен!</h3>
                        <p class="text-gray-600">Спасибо за участие. Ваши ответы сохранены.</p>
                    </div>
                    <div class="space-y-3">
                        <button onclick="viewSurveyResults()" class="glass-button px-6 py-3 rounded-lg flex items-center mx-auto">
                            <i data-feather="eye" class="mr-2"></i>
                            Посмотреть результаты
                        </button>
                        <button onclick="startNewSurvey()" class="glass-button px-6 py-3 rounded-lg flex items-center mx-auto">
                            <i data-feather="refresh-cw" class="mr-2"></i>
                            Пройти другой опрос
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="shared/ui/sidebar.js"></script>
    <script src="shared/ui/modal.js"></script>
    <script src="shared/ui/employee-selector-modal.js"></script>
    <script src="shared/ui/meeting-initiator.js"></script>
    <script src="shared/ui/active-meeting-modal.js"></script>
    <script src="shared/ui/custom-dropdown.js"></script>
    <script>
        // Инициализация sidebar
        if (typeof O2OSidebar !== 'undefined') {
            const sidebar = new O2OSidebar('surveys');
            sidebar.mount('sidebar-container');
            sidebar.startActiveMeetingCheck();
        }
        
        /**
         * Глобальная функция для обработки клика на "Встреча" в сайдбаре
         */
        async function startMeetingFromSidebar(event) {
            event.preventDefault();
            
            // Если уже на странице встречи, ничего не делаем
            if (window.location.pathname.includes('conduct-meeting.html')) {
                return;
            }
            
            try {
                // Проверяем, есть ли активная встреча
                const response = await fetch('http://localhost:3001/api/meetings/active');
                const result = await response.json();
                
                if (response.ok && result.success && result.data) {
                    // Есть активная встреча - перенаправляем на неё
                    const activeMeeting = result.data;
                    window.location.href = `conduct-meeting.html?employeeId=${activeMeeting.employeeId}&meetingId=${activeMeeting.id}`;
                } else {
                    // Нет активной встречи - используем обычную логику
                    window.meetingInitiator.initiateMeeting();
                }
            } catch (error) {
                console.error('Ошибка при проверке активной встречи:', error);
                // В случае ошибки используем обычную логику
                window.meetingInitiator.initiateMeeting();
            }
        }

        // Инициализация Feather иконок
        if (typeof feather !== 'undefined') {
            feather.replace();
        }

        // === ДАННЫЕ ===
        let surveys = [];
        let employees = [];

        // === ОСНОВНЫЕ ПЕРЕМЕННЫЕ ===
        let selectedSurvey = '';
        let selectedEmployee = '';
        let employeeDropdown = null;
        let surveyDropdown = null;
        
        // === ПЕРЕМЕННЫЕ ПРОХОЖДЕНИЯ ОПРОСА ===
        let currentSurveyResult = null;
        let currentQuestion = null;
        let currentQuestionIndex = 0;
        let surveyQuestions = [];
        let answers = {};
        let questionHistory = []; // История пройденных вопросов для кнопки "Назад"
        let isTakingSurvey = false;
        let currentSection = null; // Текущая секция
        let currentSurvey = null; // Текущий опрос для доступа к метаданным
        let hintAnimationTimer = null; // Таймер для анимации подсказки

        // === ИНИЦИАЛИЗАЦИЯ ===
        document.addEventListener('DOMContentLoaded', function() {
            loadSurveys();
            loadEmployees();
            setupEventListeners();
            initializeEmployeeDropdown();
            initializeSurveyDropdown();
            feather.replace();
        });

        // === ИНИЦИАЛИЗАЦИЯ ВЫПАДАЮЩЕГО СПИСКА ОПРОСОВ ===
        function initializeSurveyDropdown() {
            surveyDropdown = new CustomDropdown({
                placeholder: 'Выберите опрос...',
                maxVisibleItems: 3,
                enableSearch: false,
                formatItem: function(survey) {
                    // Показываем до 80 символов описания
                    const shortDescription = survey.description && survey.description.length > 80 
                        ? survey.description.substring(0, 80) + '...' 
                        : survey.description || 'Описание не указано';
                    
                    return `
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-primary rounded-full mt-2 opacity-60"></div>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900 truncate">
                                    ${survey.title}
                                </div>
                                <div class="text-xs text-gray-500 mt-1 truncate">${shortDescription}</div>
                            </div>
                        </div>
                    `;
                },
                onChange: function(survey) {
                    selectedSurvey = survey.id;
                    
                    // Обновляем скрытый input для совместимости
                    document.getElementById('survey-select').value = survey.id;
                    
                    // Вызываем обновление статуса
                    updateSurveyStatus();
                    
                    // Показываем описание опроса
                    showSurveyDescription(survey);
                    
                    console.log('Выбран опрос:', survey.id, survey.title);
                }
            });

            surveyDropdown.mount('survey-dropdown-container');
            
            // Загружаем опросы из API после создания dropdown
            loadSurveysIntoDropdown();
        }
        
        function showSurveyDescription(survey) {
            const descriptionEl = document.getElementById('survey-description');
            
            if (survey && survey.description) {
                descriptionEl.querySelector('p').textContent = survey.description;
                descriptionEl.classList.remove('hidden');
            } else {
                descriptionEl.classList.add('hidden');
            }
        }
        
        // === ЗАГРУЗКА ОПРОСОВ В DROPDOWN ===
        async function loadSurveysIntoDropdown() {
            try {
                const response = await fetch('http://localhost:3001/api/surveys?active=true');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const surveysFromAPI = data.data || [];

                console.log('Загружено опросов из API:', surveysFromAPI.length);
                
                if (surveyDropdown && surveysFromAPI.length > 0) {
                    surveyDropdown.setItems(surveysFromAPI);
                } else {
                    console.warn('Опросы не найдены или dropdown не инициализирован');
                }

            } catch (error) {
                console.error('Ошибка при загрузке опросов для dropdown:', error);
                // В случае ошибки оставляем dropdown пустым
            }
        }

        // === ЗАГРУЗКА ОПРОСОВ ===
        async function loadSurveys() {
            try {
                const response = await fetch('http://localhost:3001/api/surveys?active=true');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                surveys = data.data || [];

                console.log('Ответ API опросов:', data);
                console.log('Массив опросов:', surveys);
                console.log(`Загружено ${surveys.length} опросов`);

            } catch (error) {
                console.error('Ошибка при загрузке опросов:', error);
                // В случае ошибки API, dropdown будет работать с захардкоженными опциями
            }
        }

        // === ИНИЦИАЛИЗАЦИЯ ВЫПАДАЮЩЕГО СПИСКА СОТРУДНИКОВ ===
        function initializeEmployeeDropdown() {
            employeeDropdown = new CustomDropdown({
                placeholder: 'Выберите сотрудника...',
                maxVisibleItems: 2.5,
                enableSearch: false,
                formatItem: function(employee) {
                    // Создаем аватар (инициалы или фото)
                    const initials = `${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}`;
                    const avatarHtml = employee.photoUrl 
                        ? `<img src="${employee.photoUrl}" alt="${employee.first_name} ${employee.last_name}" class="w-8 h-8 rounded-full object-cover">`
                        : `<div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-xs font-medium">${initials}</div>`;

                    return `
                        <div class="flex items-center space-x-3">
                            ${avatarHtml}
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900 truncate">
                                    ${employee.first_name} ${employee.last_name}
                                </div>
                                <div class="text-sm text-gray-600 truncate">${employee.position}</div>
                            </div>
                        </div>
                    `;
                },
                onChange: function(employee) {
                    selectedEmployee = employee.id;
                    updateEmployeeInfo();
                    updateSurveyStatus();
                }
            });

            employeeDropdown.mount('employee-dropdown-container');
        }

        // === ЗАГРУЗКА СОТРУДНИКОВ ===
        async function loadEmployees() {
            try {
                const response = await fetch('http://localhost:3001/api/employees');
                if (!response.ok) {
                    throw new Error('Ошибка загрузки сотрудников');
                }
                
                const data = await response.json();
                employees = data.data || [];

                console.log('Ответ API сотрудников:', data);
                console.log('Массив сотрудников:', employees);

                // Обновляем кастомный выпадающий список
                if (employeeDropdown) {
                    employeeDropdown.setItems(employees);
                }

                console.log(`✅ Загружено ${employees.length} сотрудников`);
            } catch (error) {
                console.error('Ошибка при загрузке сотрудников:', error);
            }
        }

        // === ФУНКЦИИ ПРОХОЖДЕНИЯ ОПРОСА ===
        function initializeSurveyTaking(survey, employee) {
            isTakingSurvey = true;
            answers = {};
            questionHistory = []; // Очищаем историю
            currentQuestionIndex = 0;
            currentSection = null;
            currentSurvey = survey; // Сохраняем ссылку на опрос
            
            // Показываем интерфейс прохождения опроса
            document.getElementById('survey-taking-interface').classList.remove('hidden');
            document.getElementById('survey-taking-title').textContent = survey.title;
            
            // Скрываем основной интерфейс и статусный блок
            document.querySelector('.grid').style.display = 'none';
            document.getElementById('survey-status-card').style.display = 'none';
            
            feather.replace();
        }

        // Обновление состояния кнопки "Назад"
        function updateBackButton() {
            const prevBtn = document.getElementById('prev-btn');
            if (prevBtn) {
                prevBtn.disabled = questionHistory.length === 0;
            }
        }

        // Функция для раскрытия/скрытия подсказок (глобальная)
        window.toggleHints = function(hintsId) {
            const hintsElement = document.getElementById(hintsId);
            const iconElement = document.getElementById(`${hintsId}-icon`);
            const buttonElement = iconElement.closest('button');
            
            if (hintsElement.classList.contains('hidden')) {
                hintsElement.classList.remove('hidden');
                iconElement.classList.add('rotate-180');
            } else {
                hintsElement.classList.add('hidden');
                iconElement.classList.remove('rotate-180');
            }
            
            // Убираем анимацию при клике на подсказку
            if (buttonElement) {
                buttonElement.classList.remove('hint-animate');
            }
            
            feather.replace();
        };

        // Обновление индикатора секции
        function updateSectionIndicator(question) {
            if (!question || !question.section || !currentSurvey?.metadata?.sections) {
                // Скрываем индикатор если нет секции
                document.getElementById('section-indicator').classList.add('hidden');
                return;
            }

            // Проверяем, сменилась ли секция
            if (currentSection === question.section) {
                // Секция не изменилась, ничего не делаем
                return;
            }

            // Находим информацию о секции
            const section = currentSurvey.metadata.sections.find(s => s.id === question.section);
            if (!section) {
                document.getElementById('section-indicator').classList.add('hidden');
                return;
            }

            // Обновляем текущую секцию
            currentSection = question.section;

            // Обновляем UI
            const indicator = document.getElementById('section-indicator');
            const titleElement = document.getElementById('section-title');
            const descriptionElement = document.getElementById('section-description');

            titleElement.textContent = section.title;
            descriptionElement.textContent = section.description || '';

            // Показываем индикатор
            indicator.classList.remove('hidden');
        }


        function displayQuestion(question, restorePreviousAnswer = false) {
            const titleElement = document.getElementById('question-title');
            const optionsElement = document.getElementById('question-options');
            
            // Очищаем предыдущий таймер анимации подсказки
            if (hintAnimationTimer) {
                clearTimeout(hintAnimationTimer);
                hintAnimationTimer = null;
            }
            
            // Обновляем индикатор секции
            updateSectionIndicator(question);
            
            titleElement.textContent = question.title;
            optionsElement.innerHTML = '';
            
            // Обновляем состояние кнопки "Назад"
            updateBackButton();
            
            if (question.type === 'single-choice') {
                // Отладка: показываем что пришло от сервера
                console.log(`📋 Опции вопроса ${question.id}:`, question.options);
                
                question.options.forEach((option, idx) => {
                    const optionId = `option-${question.id}-${idx}`;
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option-card';
                    optionDiv.innerHTML = `
                        <label for="${optionId}" class="option-label">
                            <input type="radio" id="${optionId}" name="question-answer" value="${option.value}" class="option-radio">
                            <div class="option-content">
                                <div class="option-check"></div>
                                <span class="option-text">${option.label}</span>
                            </div>
                        </label>
                    `;
                    optionsElement.appendChild(optionDiv);
                });
                
                // Восстанавливаем предыдущий ответ если это возврат назад
                if (restorePreviousAnswer && answers[question.id]) {
                    const previousAnswer = String(answers[question.id]).toUpperCase();
                    const radioToSelect = Array.from(document.querySelectorAll(`input[name="question-answer"]`))
                        .find(inp => String(inp.value).toUpperCase() === previousAnswer);
                    if (radioToSelect) {
                        radioToSelect.checked = true;
                        radioToSelect.closest('.option-card').classList.add('selected');
                        document.getElementById('next-btn').disabled = false;
                    }
                }
                
                // Включаем кнопку "Далее" когда выбран ответ
                document.querySelectorAll('input[name="question-answer"]').forEach(input => {
                    input.addEventListener('change', () => {
                        document.getElementById('next-btn').disabled = false;
                        
                        // Убираем активный класс со всех карточек
                        document.querySelectorAll('.option-card').forEach(card => {
                            card.classList.remove('selected');
                        });
                        
                        // Добавляем активный класс к выбранной карточке
                        input.closest('.option-card').classList.add('selected');
                    });
                });
            } else if (question.type === 'textarea' || question.type === 'text') {
                // Создаем поле для ввода текста
                const textareaDiv = document.createElement('div');
                textareaDiv.className = 'w-full';
                
                const rows = question.rows || 5;
                const placeholder = question.placeholder || 'Введите ваш ответ...';
                const maxLength = question.maxLength || 1000;
                
                // Собираем HTML для подсказок (теперь раскрывающиеся)
                let hintsHtml = '';
                let hasHints = false;
                if (question.hints && question.hints.length > 0) {
                    hasHints = true;
                    const hintsId = `hints-${question.id}`;
                    const hintButtonId = `hint-btn-${question.id}`;
                    hintsHtml = `
                        <div class="mt-3">
                            <button 
                                id="${hintButtonId}"
                                type="button"
                                onclick="toggleHints('${hintsId}')"
                                class="flex items-center gap-2 text-sm text-gray-600 hover:text-gray-800 transition-colors"
                            >
                                <i data-feather="help-circle" class="w-4 h-4"></i>
                                <span>Подсказка</span>
                                <i id="${hintsId}-icon" data-feather="chevron-down" class="w-4 h-4 transition-transform"></i>
                            </button>
                            <div id="${hintsId}" class="hidden mt-2 pl-6 space-y-1.5">
                                ${question.hints.map(hint => `
                                    <div class="text-sm text-gray-600 flex items-start">
                                        <span class="mr-2 text-gray-400">•</span>
                                        <span>${hint}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                textareaDiv.innerHTML = `
                    <textarea 
                        id="text-answer" 
                        name="question-answer" 
                        rows="${rows}"
                        maxlength="${maxLength}"
                        placeholder="${placeholder}"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y"
                    ></textarea>
                    <div class="flex justify-between mt-2 text-sm text-gray-500">
                        <span>Минимум ${question.validation?.minLength || 20} символов</span>
                        <span id="char-count">0 / ${maxLength}</span>
                    </div>
                    ${hintsHtml}
                `;
                
                optionsElement.appendChild(textareaDiv);
                
                // Добавляем счетчик символов и валидацию
                const textarea = document.getElementById('text-answer');
                const charCount = document.getElementById('char-count');
                const nextBtn = document.getElementById('next-btn');
                const minLength = question.validation?.minLength || 20;
                
                // Восстанавливаем предыдущий ответ если это возврат назад
                if (restorePreviousAnswer && answers[question.id]) {
                    textarea.value = answers[question.id];
                    const length = textarea.value.length;
                    charCount.textContent = `${length} / ${maxLength}`;
                    if (length >= minLength) {
                        nextBtn.disabled = false;
                    }
                }
                
                textarea.addEventListener('input', () => {
                    const length = textarea.value.length;
                    charCount.textContent = `${length} / ${maxLength}`;
                    
                    // Включаем кнопку "Далее" только если введено минимум символов
                    if (length >= minLength) {
                        nextBtn.disabled = false;
                        textarea.classList.remove('border-red-300');
                    } else {
                        nextBtn.disabled = true;
                        if (length > 0) {
                            textarea.classList.add('border-red-300');
                        }
                    }
                });
                
                // Изначально кнопка выключена
                nextBtn.disabled = true;
                
                // Обновляем иконки feather для подсказок
                feather.replace();
                
                // Запускаем анимацию подсказки через 10 секунд
                if (hasHints) {
                    const hintButtonId = `hint-btn-${question.id}`;
                    hintAnimationTimer = setTimeout(() => {
                        const hintButton = document.getElementById(hintButtonId);
                        if (hintButton && !hintButton.classList.contains('rotate-180')) {
                            hintButton.classList.add('hint-animate');
                        }
                    }, 10000); // 10 секунд
                }
            }
        }

        async function nextQuestion() {
            let answer;
            
            // Проверяем тип вопроса
            if (currentQuestion.type === 'textarea' || currentQuestion.type === 'text') {
                // Для текстовых вопросов берем значение из textarea
                const textAnswer = document.getElementById('text-answer');
                if (!textAnswer || !textAnswer.value.trim()) return;
                answer = textAnswer.value.trim();
            } else {
                // Для вопросов с выбором берем выбранный вариант
                const selectedOption = document.querySelector('input[name="question-answer"]:checked');
                if (!selectedOption) return;
                answer = selectedOption.value;
            }
            
            // Сохраняем текущий вопрос в историю перед переходом
            questionHistory.push({
                question: currentQuestion,
                answer: answer
            });
            
            answers[currentQuestion.id] = answer;

            try {
                // Отладка: выводим что отправляем
                console.log('📤 Отправляем ответ:', {
                    questionId: currentQuestion.id,
                    value: answer,
                    selectedOption: document.querySelector('input[name="question-answer"]:checked')?.value
                });
                
                // Отправляем ответ на сервер
                const response = await fetch('http://localhost:3001/api/surveys/answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resultId: currentSurveyResult.id,
                        questionId: currentQuestion.id,
                        value: answer
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Ответ отправлен:', data);

                // Проверяем статус опроса
                if (data.data.isCompleted) {
                    // Опрос уже завершён на бэкенде
                    console.log('Опрос автоматически завершён на бэкенде');
                    showSurveyCompletion();
                    await updateSurveyStatus(); // Обновляем статус на главной странице
                } else if (data.data.question) {
                    // Есть следующий вопрос
                    currentQuestion = data.data.question;
                    displayQuestion(currentQuestion);
                    updateProgress(data.data.progress);
                    
                    // Сбрасываем кнопку "Далее"
                    document.getElementById('next-btn').disabled = true;
                } else {
                    // Странная ситуация - нет вопроса, но опрос не завершён
                    console.warn('Неожиданное состояние: нет вопроса, но опрос не завершён');
                    showSurveyCompletion();
                }

            } catch (error) {
                console.error('Ошибка при отправке ответа:', error);
                alert('Не удалось отправить ответ');
            }
        }

        async function completeSurvey() {
            try {
                const response = await fetch('http://localhost:3001/api/surveys/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resultId: currentSurveyResult.id
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Опрос завершен:', data);
                
                showSurveyCompletion();
                
                // Обновляем статус на главном экране
                updateSurveyStatus();

            } catch (error) {
                console.error('Ошибка при завершении опроса:', error);
                alert('Не удалось завершить опрос');
            }
        }

        function showSurveyCompletion() {
            document.getElementById('question-container').classList.add('hidden');
            document.getElementById('survey-completion').classList.remove('hidden');
            updateProgress({ percentage: 100 });
            feather.replace();
        }

        function updateProgress(progress) {
            if (progress && progress.percentage !== undefined) {
                document.getElementById('progress-bar').style.width = `${progress.percentage}%`;
                document.getElementById('progress-text').textContent = `${progress.percentage}%`;
            }
        }

        function cancelSurvey() {
            if (confirm('Вы уверены, что хотите отменить прохождение опроса? Прогресс будет потерян.')) {
                resetSurveyInterface();
            }
        }

        function previousQuestion() {
            // Проверяем, есть ли история
            if (questionHistory.length === 0) return;
            
            // Достаем последний вопрос из истории
            const previousEntry = questionHistory.pop();
            
            // Восстанавливаем предыдущий вопрос
            currentQuestion = previousEntry.question;
            
            // НЕ удаляем ответ из answers, чтобы он восстановился
            // answers остается с предыдущими ответами
            
            // Отображаем предыдущий вопрос с восстановлением ответа
            displayQuestion(currentQuestion, true);
            
            // Сбрасываем кнопку "Далее" (она активируется при выборе/вводе)
            document.getElementById('next-btn').disabled = false;
        }

        function viewSurveyResults() {
            resetSurveyInterface();
            // Здесь можно добавить показ результатов
            alert('Результаты опроса сохранены в базе данных');
        }

        function startNewSurvey() {
            resetSurveyInterface();
        }

        function resetSurveyInterface() {
            // Скрываем интерфейс прохождения
            document.getElementById('survey-taking-interface').classList.add('hidden');
            document.getElementById('question-container').classList.remove('hidden');
            document.getElementById('survey-completion').classList.add('hidden');
            document.getElementById('section-indicator').classList.add('hidden');
            
            // Показываем основной интерфейс
            document.querySelector('.grid').style.display = 'grid';
            
            // Очищаем таймер анимации подсказки
            if (hintAnimationTimer) {
                clearTimeout(hintAnimationTimer);
                hintAnimationTimer = null;
            }
            
            // Сбрасываем переменные
            isTakingSurvey = false;
            currentSurveyResult = null;
            currentQuestion = null;
            currentSection = null;
            currentSurvey = null;
            answers = {};
            questionHistory = []; // Очищаем историю
            
            // Обновляем статус (блок статуса покажется автоматически в updateSurveyStatus)
            updateSurveyStatus();
        }

        // === ОБРАБОТЧИКИ СОБЫТИЙ ===
        function setupEventListeners() {
            // Выбор опроса
            document.getElementById('survey-select').addEventListener('change', function(e) {
                selectedSurvey = e.target.value;
                updateSurveyDescription();
                updateSurveyStatus();
            });

            // Кнопки действий
            document.getElementById('start-survey-btn').addEventListener('click', startSurvey);
            document.getElementById('view-results-btn').addEventListener('click', viewResults);
            document.getElementById('retake-survey-btn').addEventListener('click', retakeSurvey);
        }

        // === ОБНОВЛЕНИЕ ОПИСАНИЯ ОПРОСА ===
        function updateSurveyDescription() {
            const descriptionDiv = document.getElementById('survey-description');
            
            if (selectedSurvey) {
                const survey = surveys.find(s => s.id === selectedSurvey);
                if (survey) {
                    const estimatedTime = survey.metadata?.estimatedDuration ? `${survey.metadata.estimatedDuration} минут` : 'Не указано';
                    const questionsCount = survey.questions?.length || 0;
                    
                    descriptionDiv.innerHTML = `
                        <div class="space-y-2">
                            <p class="font-medium">${survey.description || 'Описание не указано'}</p>
                            <div class="flex flex-wrap gap-4 text-xs text-gray-500">
                                <span class="flex items-center"><i data-feather="clock" class="w-3 h-3 mr-1"></i> ${estimatedTime}</span>
                                <span class="flex items-center"><i data-feather="help-circle" class="w-3 h-3 mr-1"></i> ${questionsCount} вопросов</span>
                            </div>
                        </div>
                    `;
                    descriptionDiv.classList.remove('hidden');
                    feather.replace();
                } else {
                    descriptionDiv.classList.add('hidden');
                }
            } else {
                descriptionDiv.classList.add('hidden');
            }
        }

        // === ЗАГРУЗКА СТАТУСА ПРОХОЖДЕНИЯ ОПРОСОВ ===
        async function loadSurveyResults() {
            if (!selectedEmployee || !selectedSurvey) return null;
            
            try {
                const response = await fetch(`http://localhost:3001/api/surveys/${selectedSurvey}/results?employeeId=${selectedEmployee}`);
                if (!response.ok) {
                    // Если результатов нет, это нормально
                    if (response.status === 404) {
                        return null;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Результаты опроса:', data);
                
                // API возвращает массив результатов, нужно найти завершённый
                if (data.data && data.data.length > 0) {
                    // Ищем завершённый результат для этого сотрудника
                    const completedResult = data.data.find(result => 
                        result.employeeId === selectedEmployee && result.status === 'completed'
                    );
                    
                    if (completedResult) {
                        return completedResult;
                    }
                }
                
                return null; // Завершённых результатов нет
                
            } catch (error) {
                console.error('Ошибка при загрузке результатов опроса:', error);
                return null;
            }
        }

        // === ОБНОВЛЕНИЕ ИНФОРМАЦИИ О СОТРУДНИКЕ ===
        function updateEmployeeInfo() {
            const employeeInfoDiv = document.getElementById('employee-info');
            
            if (selectedEmployee) {
                const employee = employees.find(emp => emp.id === selectedEmployee);
                if (employee) {
                    // Получаем контейнер для аватара
                    const avatarContainer = employeeInfoDiv.querySelector('.flex.items-center.space-x-3');
                    
                    // Инициалы для случая отсутствия фото
                    const initials = `${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}`;
                    
                    // Создаем HTML для аватара
                    let avatarHtml;
                    if (employee.photoUrl) {
                        avatarHtml = `<img src="${employee.photoUrl}" alt="${employee.first_name} ${employee.last_name}" class="w-10 h-10 rounded-full object-cover">`;
                    } else {
                        avatarHtml = `<div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center text-sm font-medium">${initials}</div>`;
                    }
                    
                    // Обновляем контент
                    avatarContainer.innerHTML = `
                        ${avatarHtml}
                        <div>
                            <p id="employee-name" class="font-medium">${employee.first_name} ${employee.last_name}</p>
                            <p id="employee-position" class="text-gray-500">${employee.position}${employee.team ? ' • ' + employee.team : ''}</p>
                        </div>
                    `;
                    
                    employeeInfoDiv.classList.remove('hidden');
                }
            } else {
                employeeInfoDiv.classList.add('hidden');
            }
        }

        // === ОБНОВЛЕНИЕ СТАТУСА ОПРОСА ===
        async function updateSurveyStatus() {
            const statusCard = document.getElementById('survey-status-card');
            const statusContent = document.getElementById('survey-status-content');

            if (selectedSurvey && selectedEmployee) {
                // Загружаем реальные результаты из API
                const surveyResults = await loadSurveyResults();

                statusCard.style.display = 'block';

                if (surveyResults) {
                    // У нас есть завершённый результат
                    const completedAt = new Date(surveyResults.completedAt || surveyResults.startedAt);
                    const daysAgo = Math.floor((Date.now() - completedAt.getTime()) / (1000 * 60 * 60 * 24));
                    const daysText = getDaysText(daysAgo);
                    const answersCount = surveyResults.answers ? surveyResults.answers.length : 0;
                    
                    // Получаем информацию об опросе для расчета прогресса
                    const survey = surveys.find(s => s.id === selectedSurvey);
                    const totalQuestions = survey?.questions?.length || answersCount;
                    const progressPercent = totalQuestions > 0 ? Math.round((answersCount / totalQuestions) * 100) : 100;

                    statusContent.innerHTML = `
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <!-- Основной статус -->
                            <div class="lg:col-span-2 flex items-center space-x-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <i data-feather="check-circle" class="w-4 h-4 text-green-600"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <p class="font-medium text-green-800">Опрос пройден сотрудником</p>
                                        <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded">✓ Завершен</span>
                                    </div>
                                    <p class="text-sm text-green-600">Завершен ${daysText} • ${answersCount} ответов</p>
                                </div>
                            </div>
                            
                            <!-- Статистика -->
                            <div class="space-y-2">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Прогресс:</span>
                                    <span class="font-medium text-green-600">${progressPercent}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-1.5">
                                    <div class="bg-green-500 h-1.5 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span>${answersCount}/${totalQuestions} вопросов</span>
                                    <span>${completedAt.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' })}</span>
                                </div>
                            </div>
                        </div>
                    `;

                    // Показать кнопки для просмотра и повторного прохождения
                    document.getElementById('start-survey-btn').style.display = 'none';
                    document.getElementById('view-results-btn').style.display = 'inline-flex';
                    document.getElementById('retake-survey-btn').style.display = 'inline-flex';
                } else {
                    // Опрос не пройден - получаем информацию об опросе
                    const survey = surveys.find(s => s.id === selectedSurvey);
                    const totalQuestions = survey?.questions?.length || 0;
                    const estimatedTime = survey?.metadata?.estimatedDuration || 'Не указано';
                    
                    statusContent.innerHTML = `
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            <!-- Основной статус -->
                            <div class="lg:col-span-2 flex items-center space-x-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i data-feather="play-circle" class="w-4 h-4 text-blue-600"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <p class="font-medium text-blue-800">Готов к прохождению</p>
                                        <span class="text-xs text-orange-600 bg-orange-100 px-2 py-1 rounded">Ожидает</span>
                                    </div>
                                    <p class="text-sm text-blue-600">Сотрудник еще не проходил этот опрос</p>
                                </div>
                            </div>
                            
                            <!-- Статистика -->
                            <div class="space-y-2">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Прогресс:</span>
                                    <span class="font-medium text-blue-600">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-1.5">
                                    <div class="bg-blue-500 h-1.5 rounded-full" style="width: 0%"></div>
                                </div>
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span>0/${totalQuestions} вопросов</span>
                                    <span>Готов</span>
                                </div>
                            </div>
                        </div>
                    `;

                    // Показать только кнопку начала опроса
                    document.getElementById('start-survey-btn').style.display = 'inline-flex';
                    document.getElementById('view-results-btn').style.display = 'none';
                    document.getElementById('retake-survey-btn').style.display = 'none';
                }

                feather.replace();
            } else {
                statusCard.style.display = 'none';
            }
        }

        // === ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===
        function getDaysText(days) {
            if (days === 0) return 'сегодня';
            if (days === 1) return 'вчера';
            if (days >= 2 && days <= 4) return `${days} дня назад`;
            if (days >= 5 && days <= 20) return `${days} дней назад`;
            if (days % 10 === 1 && days % 100 !== 11) return `${days} день назад`;
            if ((days % 10 >= 2 && days % 10 <= 4) && !(days % 100 >= 12 && days % 100 <= 14)) return `${days} дня назад`;
            return `${days} дней назад`;
        }

        // === ДЕЙСТВИЯ ===
        async function startSurvey() {
            if (!selectedSurvey || !selectedEmployee) return;
            
            const employee = employees.find(emp => emp.id === selectedEmployee);
            const survey = surveys.find(s => s.id === selectedSurvey);
            
            if (!employee || !survey) {
                alert('Ошибка: не найден сотрудник или опрос');
                return;
            }

            try {
                // Начинаем опрос через API
                const response = await fetch('http://localhost:3001/api/surveys/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        surveyId: selectedSurvey,
                        employeeId: selectedEmployee
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                console.log('Опрос начат:', data);

                // API /start уже возвращает первый вопрос и resultId
                currentSurveyResult = { id: data.data.resultId };
                
                // Инициализируем интерфейс прохождения
                initializeSurveyTaking(survey, employee);
                
                // Отображаем первый вопрос, который уже пришел в ответе
                if (data.data.question) {
                    currentQuestion = data.data.question;
                    displayQuestion(currentQuestion);
                    updateProgress(data.data.progress);
                } else {
                    // Опрос уже завершен
                    showSurveyCompletion();
                }

            } catch (error) {
                console.error('Ошибка при начале опроса:', error);
                alert('Не удалось начать опрос. Попробуйте еще раз.');
            }
        }

        async function viewResults() {
            if (!selectedSurvey || !selectedEmployee) return;
            
            const employee = employees.find(emp => emp.id === selectedEmployee);
            const survey = surveys.find(s => s.id === selectedSurvey);
            
            if (!employee || !survey) {
                alert('Ошибка: не найден сотрудник или опрос');
                return;
            }

            try {
                // Загружаем результаты через API
                const surveyResults = await loadSurveyResults();
                
                if (surveyResults) {
                    const completedAt = new Date(surveyResults.completedAt || surveyResults.startedAt);
                    const answersCount = surveyResults.answers ? surveyResults.answers.length : 0;
                    
                    alert(`Результаты опроса "${survey.title}"\n` +
                          `Сотрудник: ${employee.first_name} ${employee.last_name}\n` +
                          `Дата прохождения: ${completedAt.toLocaleDateString('ru-RU')}\n` +
                          `Ответов: ${answersCount}\n` +
                          `Статус: ${surveyResults.status}\n\n` +
                          `Здесь будет детальный просмотр результатов.`);
                } else {
                    alert('Результаты опроса не найдены');
                }
            } catch (error) {
                console.error('Ошибка при загрузке результатов:', error);
                alert('Не удалось загрузить результаты опроса');
            }
        }

        function retakeSurvey() {
            if (!selectedSurvey || !selectedEmployee) return;
            
            const employee = employees.find(emp => emp.id === selectedEmployee);
            const survey = surveys.find(s => s.id === selectedSurvey);
            
            if (!employee || !survey) {
                alert('Ошибка: не найден сотрудник или опрос');
                return;
            }
            
            if (confirm(`Вы уверены, что хотите пройти опрос "${survey.title}" заново?\n\nПредыдущие результаты будут перезаписаны.`)) {
                // Запускаем опрос заново
                startSurvey();
            }
        }
    </script>
</body>
</html>
